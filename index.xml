<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Feng Zhenbing's Blog</title><link>https://fengzhenbing.github.io/</link><description>Recent content on Feng Zhenbing's Blog</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Sun, 15 Aug 2021 14:16:25 +0600</lastBuildDate><atom:link href="https://fengzhenbing.github.io/index.xml" rel="self" type="application/rss+xml"/><item><title>Prometheus监控JVM</title><link>https://fengzhenbing.github.io/p/prometheus%E7%9B%91%E6%8E%A7jvm/</link><pubDate>Sun, 15 Aug 2021 14:16:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/prometheus%E7%9B%91%E6%8E%A7jvm/</guid><description>&lt;h2 id="1-jmx_exporter">1. jmx_exporter&lt;/h2>
&lt;h3 id="下载jmx_exporter">下载jmx_exporter&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">ubuntu:/# mkdir -p /usr/local/prometheus/jmx_exporter
ubuntu:/# &lt;span class="nb">cd&lt;/span> /usr/local/prometheus/jmx_exporter
ubuntu:/# wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.16.1/jmx_prometheus_javaagent-0.16.1.jar
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="配置文件jmx_exporter">配置文件jmx_exporter&lt;/h3>
&lt;p>jmx_exporter.yml&lt;/p>
&lt;pre>&lt;code> vim /usr/local/prometheus/jmx_exporter/jmx_exporter.yml
---
rules:
- pattern: &amp;quot;.*&amp;quot;
&lt;/code>&lt;/pre>&lt;h3 id="java-agent运行jmx_exporter">java agent运行jmx_exporter&lt;/h3>
&lt;p>以java agent的方式启动你的一个java应用&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">java -javaagent:/usr/local/prometheus/jmx_prometheus_javaagent-0.16.1.jar&lt;span class="o">=&lt;/span>3010:/usr/local/prometheus/jmx_exporter.yml -jar xxx-web-0.1-SNAPSHOT.jar
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="2-prometheus">2. prometheus&lt;/h2>
&lt;h3 id="docker方式下载运行">docker方式下载运行&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># docker pull prom/prometheus #下载docker镜像&lt;/span>
&lt;span class="c1"># mkdir -p /etc/prometheus&lt;/span>
&lt;span class="c1"># vim /etc/prometheus/prometheus.yml #配置&lt;/span>
&lt;span class="c1"># docker run -d \&lt;/span>
-p 192.168.3.13:9090:9090 &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> -v /etc/prometheus:/etc/prometheus &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> prom/prometheus&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="prometheus中配置上步的jmx的metrics">prometheus中配置上步的jmx的metrics&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="nt">global&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scrape_interval&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">15s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scrape_timeout&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">10s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">evaluation_interval&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">15s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">alerting&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">alertmanagers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">follow_redirects&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scheme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">timeout&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">10s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">api_version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">static_configs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">targets&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">scrape_configs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">job_name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">prometheus&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">honor_timestamps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scrape_interval&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">15s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scrape_timeout&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">10s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metrics_path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/metrics&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scheme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">follow_redirects&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">static_configs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">targets&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">192.168.3.13&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">9090&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">### 以下为jmx_exporter地址：需改为你实际的&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">job_name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;jmx&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">static_configs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scrape_interval&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">15s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">targets&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;192.168.3.14:3010&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="验证">验证&lt;/h3>
&lt;p>访问http://192.168.3.13:9090 可看到读取的jmx_exporter的metrics&lt;/p>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/image-20210815150732316.png" alt="image-20210815150732316" />&lt;/p>
&lt;h2 id="3-grafana连接prometheus">3. Grafana连接Prometheus&lt;/h2>
&lt;pre>&lt;code>docker pull grafana/grafana
docker run -d --name=grafana -p 3000:3000 grafana/grafana
&lt;/code>&lt;/pre>&lt;p>访问http://192.168.3.13:3000 使用admin/admin即可登录&lt;/p>
&lt;h3 id="配置prometheus数据源">配置prometheus数据源&lt;/h3>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/image-20210815153009091.png" alt="image-20210815153009091" />&lt;/p>
&lt;h3 id="配置dashboard">配置dashboard&lt;/h3>
&lt;p>找一个合适的dashboard导入。如https://grafana.com/grafana/dashboards/3457&lt;/p>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/image-20210815160530374.png" alt="image-20210815160530374" />&lt;/p>
&lt;h3 id="效果">效果&lt;/h3>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/image-20210815160638492.png" alt="image-20210815160638492" />&lt;/p>
&lt;h2 id="参考">参考&lt;/h2>
&lt;ul>
&lt;li>prometheus安装 &lt;a href="https://prometheus.io/docs/prometheus/latest/installation/">https://prometheus.io/docs/prometheus/latest/installation/&lt;/a>&lt;/li>
&lt;/ul>
&lt;ul>
&lt;li>JMX Exporter 项目地址: &lt;a href="https://github.com/prometheus/jmx_exporter">https://github.com/prometheus/jmx_exporter&lt;/a>&lt;/li>
&lt;li>JVM 监控面板: &lt;a href="https://grafana.com/grafana/dashboards/3457">https://grafana.com/grafana/dashboards/3457&lt;/a>&lt;/li>
&lt;li>Grafana(&lt;a href="https://grafana.com/">https://grafana.com/&lt;/a>)&lt;/li>
&lt;/ul></description></item><item><title>Disruptor高性能队列</title><link>https://fengzhenbing.github.io/p/disruptor%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97/</link><pubDate>Tue, 20 Jul 2021 00:00:00 +0000</pubDate><guid>https://fengzhenbing.github.io/p/disruptor%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97/</guid><description>&lt;h2 id="disruptor通过以下设计来解决队列速度慢的问题">Disruptor通过以下设计来解决队列速度慢的问题：&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>环形数组结构&lt;/p>
&lt;/li>
&lt;li>
&lt;p>元素位置定位&lt;/p>
&lt;p>数组长度2^n， 位运算，加快定位的速度&lt;/p>
&lt;/li>
&lt;li>
&lt;p>无锁设计&lt;/p>
&lt;p>Cas操作保证线程安全&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="参考">参考&lt;/h2>
&lt;p>&lt;a href="https://tech.meituan.com/2016/11/18/disruptor.html">https://tech.meituan.com/2016/11/18/disruptor.html&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://blog.csdn.net/liweisnake/article/details/9113119">https://blog.csdn.net/liweisnake/article/details/9113119&lt;/a>&lt;/p></description></item><item><title>Envoy</title><link>https://fengzhenbing.github.io/p/envoy/</link><pubDate>Tue, 20 Jul 2021 00:00:00 +0000</pubDate><guid>https://fengzhenbing.github.io/p/envoy/</guid><description>&lt;h2 id="envoy概述">Envoy概述&lt;/h2>
&lt;p>Envoy 是以 C++ 开发的高性能代理;&lt;/p>
&lt;p>其内置服务发现、负载均衡、TLS终止、HTTP/2、GRPC代理、熔断器、健康检查，基于百分比流量拆分的灰度发布、故障注入等功能&lt;/p>
&lt;p>&lt;img src="http://dockone.io/uploads/article/20190722/e56882465fb16ac21248567c621b90f9.png" alt="1.png" />&lt;/p>
&lt;ul>
&lt;li>Downstream：下游主机，指连接到Envoy的主机，这些主机用来发送请求并接受响应。&lt;/li>
&lt;li>Upstream：上游主机，指接收来自Envoy连接和请求的主机，并返回响应。&lt;/li>
&lt;li>Listener：服务或程序的监听器， Envoy暴露一个或多个监听器监听下游主机的请求，当监听到请求时，通过Filter Chain把对请求的处理全部抽象为Filter， 例如ReadFilter、WriteFilter、HttpFilter等。&lt;/li>
&lt;li>Cluster：服务提供集群，指Envoy连接的一组逻辑相同的上游主机。Envoy通过服务发现功能来发现集群内的成员，通过负载均衡功能将流量路由到集群的各个成员。&lt;/li>
&lt;li>xDS：xDS中的x是一个代词，类似云计算里的XaaS可以指代IaaS、PaaS、SaaS等。DS为Discovery Service，即发现服务的意思。xDS包括CDS（cluster discovery service）、RDS（route discovery service）、EDS（endpoint discovery service）、ADS（aggregated discovery service），其中ADS称为聚合的发现服务，是对CDS、RDS、LDS、EDS服务的统一封装，解决CDS、RDS、LDS、EDS信息更新顺序依赖的问题，从而保证以一定的顺序同步各类配置信息。以上Endpoint、Cluster、Route的概念介绍如下：
&lt;ul>
&lt;li>Endpoint：一个具体的“应用实例”，类似于Kubernetes中的一个Pod；&lt;/li>
&lt;li>Cluster：可以理解“应用集群”，对应提供相同服务的一个或多个Endpoint， 类似Kubernetes中Service概念，即一个Service提供多个相同服务的Pod；&lt;/li>
&lt;li>Route：当我们做金丝雀发布部署时，同一个服务会有多个版本，这时需要Route规则规定请求如何路由到其中的某个版本上。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;a href="http://www.dockone.io/article/9116">http://www.dockone.io/article/9116&lt;/a>&lt;/p></description></item><item><title>服务链路追踪</title><link>https://fengzhenbing.github.io/p/%E6%9C%8D%E5%8A%A1%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/</link><pubDate>Sat, 12 Jun 2021 00:00:00 +0000</pubDate><guid>https://fengzhenbing.github.io/p/%E6%9C%8D%E5%8A%A1%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/</guid><description>&lt;h2 id="背景">背景&lt;/h2>
&lt;p>随着业务的发展，系统规模也会越来越大，各微服务间的调用关系也越来越错综复杂，每一个前端请求都会形成一条复杂的分布式服务调用链路，在每条链路中任何一个依赖服务出现延迟过高或错误的时候都会引起请求最后的失败。&lt;/p>
&lt;h2 id="链路追踪原理">链路追踪原理&lt;/h2>
&lt;h3 id="实现请求跟踪">实现请求跟踪&lt;/h3>
&lt;p>当请求发送到分布式系统的入口端点时，只需要服务跟踪框架为该请求创建一个唯一的跟踪标识&lt;strong>Trace ID&lt;/strong>，&lt;/p>
&lt;p>同时在分布式系统内部流转的时候，框架失踪保持该唯一标识，直到返回给请求方位置。&lt;/p>
&lt;p>&lt;strong>trace&lt;/strong>：&lt;strong>服务追踪的追踪单元&lt;/strong>是从客户发起请求（request）抵达被追踪系统的边界开始，到被追踪系统向客户返回响应（response）为止的过程，称为一&lt;/p>
&lt;p>个“trace”&lt;/p>
&lt;h3 id="统计各处理单元的时间延迟">统计各处理单元的时间延迟&lt;/h3>
&lt;p>当请求到达各个服务组件时，也是通过一个唯一标识&lt;strong>Span ID&lt;/strong>来标记它的开始，具体过程以及结束。对每一个Span来说，它必须有开始和结束两个节点，通过记录开始Span和结束Span的时间戳，就能统计出该Span的时间延迟，除了时间戳记录之外，它还可以包含一些其他元数据，比如时间名称、请求信息等。&lt;/p>
&lt;h3 id="ui可视化">UI可视化&lt;/h3>
&lt;h2 id="apm技术组件">APM技术组件&lt;/h2>
&lt;h3 id="zipkinsleuth">Zipkin+Sleuth&lt;/h3>
&lt;h3 id="apache-skywalking">Apache SkyWalking&lt;/h3>
&lt;h3 id="cat">Cat&lt;/h3>
&lt;h3 id="pinpoint">Pinpoint&lt;/h3>
&lt;h3 id="特点对比">特点对比&lt;/h3>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/image-20210719093354996.png" alt="image-20210719093354996" />&lt;/p></description></item><item><title>k8s Kubectl命令</title><link>https://fengzhenbing.github.io/p/k8s-kubectl%E5%91%BD%E4%BB%A4/</link><pubDate>Thu, 10 Jun 2021 00:00:00 +0000</pubDate><guid>https://fengzhenbing.github.io/p/k8s-kubectl%E5%91%BD%E4%BB%A4/</guid><description>&lt;h2 id="kubelet日志">kubelet日志&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">journalctl -fu kubelet
kubectl -h
kubectl get namespaces
kubectl get pods -A
kubectl logs -f --tail&lt;span class="o">=&lt;/span>&lt;span class="m">200&lt;/span> -l &lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>account -n bookstore-microservices
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="常用命令">常用命令&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#查看端口映射&lt;/span>
kubectl get svc -n kube-system
&lt;span class="c1">#查看 secret&lt;/span>
kubectl get secret -n kube-system
&lt;span class="c1">#查看 token&lt;/span>
kubectl describe secret kubernetes-dashboard --namespace&lt;span class="o">=&lt;/span>kube-system
&lt;span class="c1">#k8s 无法启动，查看日志，查找Failed&lt;/span>
journalctl -xefu kubelet
&lt;span class="c1">#查看pod错误日志&lt;/span>
kubectl logs kubernetes-dashboard-8556c848b7-4kpzd --namespace&lt;span class="o">=&lt;/span>kube-system
&lt;span class="c1">#对资源进行配置&lt;/span>
kubectl apply -f kubernetes-dashboard.yaml
kubectl delete -f kubernetes-dashboard.ya
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="yaml配置文件管理对象">YAML配置文件管理对象&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">对象管理：
&lt;span class="c1"># 创建deployment资源&lt;/span>
kubectl create -f nginx-deployment.yaml
&lt;span class="c1"># 查看deployment&lt;/span>
kubectl get deploy
&lt;span class="c1"># 查看ReplicaSet&lt;/span>
kubectl get rs
&lt;span class="c1"># 查看pods所有标签&lt;/span>
kubectl get pods --show-labels
&lt;span class="c1"># 根据标签查看pods&lt;/span>
kubectl get pods -l &lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>nginx
&lt;span class="c1"># 滚动更新镜像&lt;/span>
kubectl &lt;span class="nb">set&lt;/span> image deployment/nginx-deployment &lt;span class="nv">nginx&lt;/span>&lt;span class="o">=&lt;/span>nginx:1.11
或者
kubectl edit deployment/nginx-deployment
或者
kubectl apply -f nginx-deployment.yaml
&lt;span class="c1"># 实时观察发布状态：&lt;/span>
kubectl rollout status deployment/nginx-deployment
&lt;span class="c1"># 查看deployment历史修订版本&lt;/span>
kubectl rollout &lt;span class="nb">history&lt;/span> deployment/nginx-deployment
kubectl rollout &lt;span class="nb">history&lt;/span> deployment/nginx-deployment --revision&lt;span class="o">=&lt;/span>&lt;span class="m">3&lt;/span>
&lt;span class="c1"># 回滚到以前版本&lt;/span>
kubectl rollout undo deployment/nginx-deployment
kubectl rollout undo deployment/nginx-deployment --to-revision&lt;span class="o">=&lt;/span>&lt;span class="m">3&lt;/span>
&lt;span class="c1"># 扩容deployment的Pod副本数量&lt;/span>
kubectl scale deployment nginx-deployment --replicas&lt;span class="o">=&lt;/span>&lt;span class="m">10&lt;/span>
&lt;span class="c1"># 设置启动扩容/缩容&lt;/span>
kubectl autoscale deployment nginx-deployment --min&lt;span class="o">=&lt;/span>&lt;span class="m">10&lt;/span> --max&lt;span class="o">=&lt;/span>&lt;span class="m">15&lt;/span> --cpu-percent&lt;span class="o">=&lt;/span>&lt;span class="m">80&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>架构演变</title><link>https://fengzhenbing.github.io/p/%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8F%98/</link><pubDate>Thu, 10 Jun 2021 00:00:00 +0000</pubDate><guid>https://fengzhenbing.github.io/p/%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8F%98/</guid><description>&lt;h2 id="单体架构spring-boot">单体架构(spring boot)&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>优点：所有代码都运行在同一个进程空间之内，所有模块、方法的调用都无须考虑网络分区、对象复制这些麻烦的事和性能损失。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>缺点：损失了各个功能模块的自治、隔离能力；&lt;/p>
&lt;p>​ 由于隔离能力的缺失难以阻断错误传播、不便于动态更新程序以外，还面临难以技术异构的困难&lt;/p>
&lt;p>​ 可以 使用OSGi 这种运行时模块化框架，但是太复杂了。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="soa-架构service-oriented-architecture">SOA 架构（Service-Oriented Architecture）&lt;/h2>
&lt;p>面向服务的架构是一次具体地、系统性地成功解决分布式服务主要问题的架构模式。&lt;/p>
&lt;p>SOAP 协议被逐渐边缘化的本质原因：过于严格的规范定义带来过度的复杂性。而构建在 SOAP 基础之上的 ESB、BPM、SCA、SDO 等诸多上层建筑，进一步加剧了这种复杂性。&lt;/p>
&lt;h2 id="微服务架构spring-cloud">微服务架构(spring cloud)&lt;/h2>
&lt;p>微服务是一种软件开发技术，是一种 SOA 的变体形式。&lt;/p>
&lt;p>升级背景：&lt;/p>
&lt;ul>
&lt;li>制约软件质量与业务能力提升的最大因素是人而非硬件： 单体架构没有什么有效阻断错误传播的手段&lt;/li>
&lt;li>技术异构的需求从可选渐渐成为必须：很多 Java 不擅长的事情 人工智能python 分布式协调工具 Etcd ,NSI C 编写的 Redis，&lt;/li>
&lt;li>&amp;hellip;&lt;/li>
&lt;/ul>
&lt;p>由于隔离能力的缺失，单体除了难以阻断错误传播、不便于动态更新程序以外，还面临难以技术异构的困难，每个模块的代码都通常需要使用一样的程序语言，乃至一样的编程框架去开发。&lt;/p>
&lt;p>随着软件架构演进，构筑可靠系统从“追求尽量不出错”，到正视“出错是必然”的观念转变，才是微服务架构得以挑战并逐步开始取代运作了数十年的单体架构的底气所在&lt;/p>
&lt;p>微服务时代充满着自由的气息，微服务时代充斥着迷茫的选择。&lt;/p>
&lt;h2 id="微服务架构kubernetes">微服务架构(Kubernetes)&lt;/h2>
&lt;p>升级背景：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>微服务中的各种新技术名词，如配置中心、服务发现、网关、熔断、负载均衡等等带来的技术组件 Config、Eureka、Zuul、Hystrix、Ribbon、Feign 等&lt;/p>
&lt;p>占据了产品的大部分编译后的代码容量&lt;/p>
&lt;p>之前在应用层面而不是基础设施层面去解决这些分布式问题，完全是因为由硬件构成的基础设施，跟不上由软件构成的应用服务的灵活性的无奈之举&lt;/p>
&lt;/li>
&lt;li>
&lt;p>以 Docker Swarm、Apache Mesos 与 Kubernetes 为主要竞争者的“容器战争”终于有了明确的结果，Kubernetes 登基加冕&lt;/p>
&lt;p>容器动态构建出 DNS 服务器、服务负载均衡器等一系列虚拟化的基础设施，去代替原有的应用层面的技术组件&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;em>Microservice&lt;/em> &lt;a href="https://martinfowler.com/articles/microservices.html">https://martinfowler.com/articles/microservices.html&lt;/a>&lt;/p>
&lt;h2 id="服务网格service-mesh">服务网格（Service Mesh）&lt;/h2>
&lt;p>升级背景：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>基础设施是针对整个容器来管理的，粒度相对粗旷，只能到容器层面，对单个远程服务就很难有效管控。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>服务的监控、认证、授权、安全、负载均衡等都有可能面临细化管理的需求&lt;/p>
&lt;p>譬如服务调用时的负载均衡，往往需要根据流量特征，调整负载均衡的层次、算法，等等，而 DNS 尽管能实现一定程度的负载均衡，但通常并不能满足这些额外的需求。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="边车代理模式sidecar-proxy">“边车代理模式”（Sidecar Proxy）&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>数据平面通信：这个代理除了实现正常的服务间通信外（称为数据平面通信）&lt;/p>
&lt;/li>
&lt;li>
&lt;p>控制平面通信：还接收来自控制器的指令（称为控制平面通信），根据控制平面中的配置，对数据平面通信的内容进行分析处理，以实现熔断、认证、度量、监控、负载均衡等各种附加功能。&lt;/p>
&lt;p>通过&lt;/p>
&lt;p>主要框架：&lt;a class="link" href="![]%28https://gitee.com/fengzhenbing/picgo/raw/master/image-20210721231153297.png%29" >Istio&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/image-20210721231153297.png" alt="image-20210721231153297" />&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>上帝的归上帝，凯撒的归凯撒，业务与技术完全分离，远程与本地完全透明，也许这就是最好的时代了吧？&lt;/p>
&lt;h2 id="无服务">无服务&lt;/h2>
&lt;p>更应该成为 无服务器&lt;/p>
&lt;p>包含两方面：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>后端设施&lt;/strong>：指数据库、消息队列、日志、存储，等等这一类用于支撑业务逻辑运行，但本身无业务含义的技术组件，这些后端设施都运行在云中，无服务中称其为“后端即服务”（Backend as a Service，BaaS）。&lt;/li>
&lt;li>&lt;strong>函数&lt;/strong>： 指业务逻辑代码，这里函数的概念与粒度，都已经很接近于程序编码角度的函数了，其区别是无服务中的函数运行在云端，不必考虑算力问题，不必考虑容量规划（从技术角度可以不考虑，从计费的角度你的钱包够不够用还是要掂量一下的），无服务中称其为“函数即服务”（Function as a Service，FaaS）。&lt;/li>
&lt;/ul></description></item><item><title>Kubeadm安装Kubernetes</title><link>https://fengzhenbing.github.io/p/kubeadm%E5%AE%89%E8%A3%85kubernetes/</link><pubDate>Tue, 08 Jun 2021 00:00:00 +0000</pubDate><guid>https://fengzhenbing.github.io/p/kubeadm%E5%AE%89%E8%A3%85kubernetes/</guid><description>&lt;h2 id="1环境准备">1.环境准备&lt;/h2>
&lt;p>安装 Kubernetes 最小需要 2 核处理器、2 GB 内存，且为 x86 架构（暂不支持 ARM 架构)&lt;/p>
&lt;p>本次实验操作系统：ubantu 20.04LTS&lt;/p>
&lt;p>Kubernetes 并不在主流 Debian 系统自带的软件源中，所以要手工注册，然后才能使用&lt;code>apt-get&lt;/code>安装&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># 添加GPG Key&lt;/span>
$ sudo curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg &lt;span class="p">|&lt;/span> sudo apt-key add -
&lt;span class="c1"># 添加K8S软件源&lt;/span>
$ sudo add-apt-repository &lt;span class="s2">&amp;#34;deb https://apt.kubernetes.io/ kubernetes-xenial main&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>如果不能科学上网，可以使用阿里云的软件源地址&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># 添加GPG Key&lt;/span>
$ curl -fsSL http://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg &lt;span class="p">|&lt;/span> sudo apt-key add -
&lt;span class="c1"># 添加K8S软件源&lt;/span>
$ sudo add-apt-repository &lt;span class="s2">&amp;#34;deb http://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>添加源后需要更新&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">sudo apt-get update
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="2-安装-kubeletkubectlkubeadm">2. 安装 &lt;strong>kubelet&lt;/strong>、&lt;strong>kubectl&lt;/strong>、&lt;strong>kubeadm&lt;/strong>&lt;/h2>
&lt;p>官网介绍：https://kubernetes.io/docs/reference/setup-tools/kubeadm/&lt;/p>
&lt;ul>
&lt;li>kubeadm: 引导启动 Kubernate 集群的命令行工具。&lt;/li>
&lt;li>kubelet: 在群集中的所有计算机上运行的组件, 并用来执行如启动 Pods 和 Containers 等操作。&lt;/li>
&lt;li>kubectl: 用于操作运行中的集群的命令行工具。&lt;/li>
&lt;/ul>
&lt;h3 id="21关闭swap-分区">2.1关闭Swap 分区&lt;/h3>
&lt;p>kubeadm 初始化集群之前，需要关闭Swap 分区，首先基于安全性（如在官方文档中承诺的 Secret 只会在内存中读写，不会落盘）、利于保证节点同步一致性等原因，从 1.8 版开始，Kubernetes 就在它的文档中明确声明了它默认&lt;strong>不支持&lt;/strong>Swap 分区，在未关闭 Swap 分区的机器中，集群将直接无法启动；&lt;/p>
&lt;p>其他参考&lt;/p>
&lt;blockquote>
&lt;p>主要有两个方面原因：&lt;/p>
&lt;p>第一是因为性能问题，在生产环境我们经常会遇到容器性能突然降低的情况，查看原因后，大部分都是因为开启了swap导致的。swap看似解决了有限内存的问题，但这种通过时间换空间的做法也给性能带来了很大问题，尤其是在高并发场景中，很容易导致系统不稳定。&lt;/p>
&lt;p>第二是因为k8s定义的资源模型中，CPU和内存都是确定的可用资源，在调度的时候都会考虑在内。比如，设置了内存设置了limit 2G，就代表最大可用内存是2G，而引入swap（cgroup支持swap限制）后这个模型就变得复杂了，而且需要结合Qos，swap的使用完全是由操作系统根据水位自行调节的，并不直接受kubelet管理&lt;/p>
&lt;/blockquote>
&lt;p>一次性关闭&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">sudo swapoff -a
&lt;/code>&lt;/pre>&lt;/div>&lt;p>永久关闭&lt;/p>
&lt;p>编辑器打开&lt;code>/etc/fstab&lt;/code>，注释其中带有“swap”的行即可，&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># 先备份&lt;/span>
$ yes &lt;span class="p">|&lt;/span> sudo cp /etc/fstab /etc/fstab_bak
&lt;span class="c1"># 进行修改&lt;/span>
$ sudo cat /etc/fstab_bak &lt;span class="p">|&lt;/span> grep -v swap &amp;gt; /etc/fstab
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="3-预拉取镜像">3 预拉取镜像&lt;/h2>
&lt;p>先查看kubeadm版本 v1.21.3&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">root@fengzhenbing-ubuntu:/home/fengzhenbing# kubeadm version
kubeadm version: &lt;span class="p">&amp;amp;&lt;/span>version.Info&lt;span class="o">{&lt;/span>Major:&lt;span class="s2">&amp;#34;1&amp;#34;&lt;/span>, Minor:&lt;span class="s2">&amp;#34;21&amp;#34;&lt;/span>, GitVersion:&lt;span class="s2">&amp;#34;v1.21.3&amp;#34;&lt;/span>, GitCommit:&lt;span class="s2">&amp;#34;ca643a4d1f7bfe34773c74f79527be4afd95bf39&amp;#34;&lt;/span>, GitTreeState:&lt;span class="s2">&amp;#34;clean&amp;#34;&lt;/span>, BuildDate:&lt;span class="s2">&amp;#34;2021-07-15T21:03:28Z&amp;#34;&lt;/span>, GoVersion:&lt;span class="s2">&amp;#34;go1.16.6&amp;#34;&lt;/span>, Compiler:&lt;span class="s2">&amp;#34;gc&amp;#34;&lt;/span>, Platform:&lt;span class="s2">&amp;#34;linux/amd64&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>首先使用以下命令查询当前版本需要哪些镜像：&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">fengzhenbing@fengzhenbing-ubuntu:/etc/docker$ kubeadm config images list --kubernetes-version v1.21.3
k8s.gcr.io/kube-apiserver:v1.21.3
k8s.gcr.io/kube-controller-manager:v1.21.3
k8s.gcr.io/kube-scheduler:v1.21.3
k8s.gcr.io/kube-proxy:v1.21.3
k8s.gcr.io/pause:3.4.1
k8s.gcr.io/etcd:3.4.13-0
k8s.gcr.io/coredns/coredns:v1.8.0
&lt;/code>&lt;/pre>&lt;/div>&lt;p>k8s.gcr.io 为google官方（Google Container Registry），对于不能科学上网的同学来说，可以使用阿里云加速&lt;/p>
&lt;h3 id="31-配置阿里云加速地址">3.1 配置阿里云加速地址&lt;/h3>
&lt;p>阿里云加速地址获取 &lt;a href="https://cr.console.aliyun.com/cn-shanghai/instances/mirrors">https://cr.console.aliyun.com/cn-shanghai/instances/mirrors&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/image-20210725221057446.png" alt="image-20210725221057446" />&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">sudo tee /etc/docker/daemon.json &lt;span class="s">&amp;lt;&amp;lt;-&amp;#39;EOF&amp;#39;
&lt;/span>&lt;span class="s">{
&lt;/span>&lt;span class="s"> &amp;#34;registry-mirrors&amp;#34;: [&amp;#34;https://xxxx.mirror.aliyuncs.com&amp;#34;]
&lt;/span>&lt;span class="s">}
&lt;/span>&lt;span class="s">EOF&lt;/span>
sudo systemctl daemon-reload
sudo systemctl restart docker
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="32-拉取镜像修改tag">3.2 拉取镜像，修改tag&lt;/h3>
&lt;p>对于通过&lt;code>kubeadm config images list --kubernetes-version v1.21.3&lt;/code>查找到需要下载的镜像名称及版本后，可以从&lt;a class="link" href="https://hub.docker.com/" target="_blank" rel="noopener"
>DockerHub&lt;/a>上找存有相同镜像的仓库来拉取。 我是用的&lt;a class="link" href="https://hub.docker.com/r/k8simage/kube-proxy" target="_blank" rel="noopener"
>k8simage&lt;/a>的仓库，找到对应的v1.21.3版本的对应image&lt;/p>
&lt;p>下面为从k8simage拉取到的镜像&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">fengzhenbing@fengzhenbing-ubuntu:/etc/docker$ sudo docker image list
REPOSITORY TAG IMAGE ID CREATED SIZE
k8simage/kube-apiserver v1.21.3 3d174f00aa39 &lt;span class="m">9&lt;/span> days ago 126MB
k8simage/kube-scheduler v1.21.3 6be0dc1302e3 &lt;span class="m">9&lt;/span> days ago 50.6MB
k8simage/kube-controller-manager v1.21.3 bc2bb319a703 &lt;span class="m">9&lt;/span> days ago 120MB
k8simage/kube-proxy v1.21.3 adb2816ea823 &lt;span class="m">9&lt;/span> days ago 103MB
k8simage/pause 3.4.1 0f8457a4c2ec &lt;span class="m">6&lt;/span> months ago 683kB
k8simage/etcd 3.4.13-0 0369cf4303ff &lt;span class="m">11&lt;/span> months ago 253MB
k8simage/coredns 1.7.0 bfe3a36ebd25 &lt;span class="m">13&lt;/span> months ago 45.2MB
&lt;/code>&lt;/pre>&lt;/div>&lt;p>对每一镜像，1先拉取，2修改tag 3最后删除原来的。以kube-apiserver v1.21.3为例子&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">sudo docker pull k8simage/kube-apiserver:v1.21.3
sudo docker tag k8simage/kube-apiserver:v1.21.3 k8s.gcr.io/kube-apiserver:v1.21.3
sudo docker rmi k8simage/kube-apiserver:v1.21.3
&lt;/code>&lt;/pre>&lt;/div>&lt;p>上面全部操作结束后 可看到都更新为&lt;code>kubeadm config images list --kubernetes-version v1.21.3&lt;/code>所需要的镜像了&lt;/p>
&lt;pre>&lt;code>root@fengzhenbing-ubuntu:/home/fengzhenbing# sudo docker image list
REPOSITORY TAG IMAGE ID CREATED SIZE
k8s.gcr.io/kube-apiserver v1.21.3 3d174f00aa39 9 days ago 126MB
k8s.gcr.io/kube-scheduler v1.21.3 6be0dc1302e3 9 days ago 50.6MB
k8s.gcr.io/kube-proxy v1.21.3 adb2816ea823 9 days ago 103MB
k8s.gcr.io/kube-controller-manager v1.21.3 bc2bb319a703 9 days ago 120MB
quay.io/coreos/flannel v0.14.0 8522d622299c 2 months ago 67.9MB
k8s.gcr.io/pause 3.4.1 0f8457a4c2ec 6 months ago 683kB
k8s.gcr.io/etcd 3.4.13-0 0369cf4303ff 11 months ago 253MB
k8s.gcr.io/coredns/coredns v1.8.0 bfe3a36ebd25 13 months ago 45.2MB
&lt;/code>&lt;/pre>&lt;h2 id="4-初始化集群控制平面">4 初始化集群控制平面&lt;/h2>
&lt;ul>
&lt;li>确保 kubelet 是开机启动的&lt;/li>
&lt;/ul>
&lt;pre>&lt;code>fengzhenbing@fengzhenbing-ubuntu:/etc/docker$ sudo systemctl start kubelet
fengzhenbing@fengzhenbing-ubuntu:/etc/docker$ sudo systemctl enable kubelet
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>su 直接切换到 root 用户， 保证是root启动部署&lt;/li>
&lt;/ul>
&lt;pre>&lt;code>kubeadm init \
--pod-network-cidr=10.244.0.0/16 \
--kubernetes-version v1.21.3 \
--control-plane-endpoint 192.168.3.13
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>参数介绍&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>&lt;code>--kubernetes-version&lt;/code>参数（要注意版本号与 kubelet 一致）的目的是与前面预拉取是一样的，避免额外的网络访问去查询版本号；如果能够科学上网，不需要加这个参数。&lt;/p>
&lt;p>&lt;code>--pod-network-cidr&lt;/code>参数是给Flannel网络做网段划分使用的，着在稍后介绍完 CNI 网络插件时会去说明。&lt;/p>
&lt;p>&lt;code>--control-plane-endpoint&lt;/code>参数是控制面的地址，强烈建议使用一个域名代替直接的IP地址来建立Kubernetes集群。因为CA证书直接与地址相关，Kubernetes中诸多配置（配置文件、ConfigMap资源）也直接存储了这个地址，一旦更换IP，要想要不重置集群，手工换起来异常麻烦。所以最好使用hostname（仅限单节点实验）或者dns name。&lt;/p>
&lt;/blockquote>
&lt;p>执行完，如下提示表明成功&lt;/p>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/image-20210725225837358.png" alt="image-20210725225837358" />&lt;/p>
&lt;h2 id="5-为当前用户生成-kubeconfig">5 为当前用户生成 &lt;strong>kubeconfig&lt;/strong>&lt;/h2>
&lt;p>使用 Kubernetes 前需要为当前用户先配置好 admin.conf 文件&lt;/p>
&lt;pre>&lt;code>root@fengzhenbing-ubuntu:~# mkdir -p $HOME/.kube
root@fengzhenbing-ubuntu:~# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
root@fengzhenbing-ubuntu:~# sudo chown $(id -u):$(id -g) $HOME/.kube/config
&lt;/code>&lt;/pre>&lt;h2 id="6-cni插件">6 CNI插件&lt;/h2>
&lt;p>CNI 即“容器网络接口”&lt;/p>
&lt;p>部署 Kubernetes 时，我们可以有两种网络方案使得以后受管理的容器之间进行网络通讯：&lt;/p>
&lt;ul>
&lt;li>使用 Kubernetes 的默认网络： 操作太复杂&lt;/li>
&lt;li>使用 CNI 及其插件：&lt;/li>
&lt;/ul>
&lt;p>Flannel 插件为比较推荐的&lt;/p>
&lt;h3 id="安装flannel-插件">安装Flannel 插件&lt;/h3>
&lt;pre>&lt;code>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
&lt;/code>&lt;/pre>&lt;p>&lt;a href="https://raw.githubusercontent.com">https://raw.githubusercontent.com&lt;/a> 无法访问时，可以找到该yml文件上传到服务器，如下执行&lt;/p>
&lt;pre>&lt;code>root@fengzhenbing-ubuntu:/home/fengzhenbing# kubectl apply -f kube-flannel.yml
Warning: policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+
podsecuritypolicy.policy/psp.flannel.unprivileged created
clusterrole.rbac.authorization.k8s.io/flannel created
clusterrolebinding.rbac.authorization.k8s.io/flannel created
serviceaccount/flannel created
configmap/kube-flannel-cfg created
daemonset.apps/kube-flannel-ds created
&lt;/code>&lt;/pre>&lt;pre>&lt;code>$ kubectl taint nodes --all node-role.kubernetes.io/master-
&lt;/code>&lt;/pre>&lt;h2 id="7-kubectl-命令自动补全功能">7 &lt;strong>kubectl&lt;/strong> 命令自动补全功能&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;source &amp;lt;(kubectl completion bash)&amp;#39;&lt;/span> &amp;gt;&amp;gt; ~/.bashrc
$ &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;source /usr/share/bash-completion/bash_completion&amp;#39;&lt;/span> &amp;gt;&amp;gt; ~/.bashrc
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="8-加入其他-node-节点到-kubernetes-集群中">8 加入其他 &lt;strong>Node&lt;/strong> 节点到 &lt;strong>Kubernetes&lt;/strong> 集群中&lt;/h2>
&lt;p>kubeadm init执行成功后的反馈内容中有提到：如上面的截图&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">You can now join any number of control-plane nodes by copying certificate authorities
and service account keys on each node and &lt;span class="k">then&lt;/span> running the following as root:
kubeadm join 192.168.3.13:6443 --token qxu02l.g995k2yhkxjh3k80 &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --discovery-token-ca-cert-hash sha256:b9887f55b739bd89d3b0dbb038e693df9b5b7d9759902ffb2a250288ba1ffc25 &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --control-plane
Then you can join any number of worker nodes by running the following on each as root:
kubeadm join 192.168.3.13:6443 --token qxu02l.g995k2yhkxjh3k80 &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --discovery-token-ca-cert-hash sha256:b9887f55b739bd89d3b0dbb038e693df9b5b7d9759902ffb2a250288ba1ffc25
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Token 的有效时间为 24 小时，如果超时，使用以下命令重新获取：&lt;/p>
&lt;pre>&lt;code>$ kubeadm token create --print-join-command
&lt;/code>&lt;/pre>&lt;h2 id="9相关问题">9相关问题&lt;/h2>
&lt;p>无法访问api端点如下&lt;/p>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/image-20210725233415235.png" alt="image-20210725233415235" />&lt;/p>
&lt;p>对于实验测试非线上来讲，可以直接将&lt;code>system:anonymous&lt;/code>加为用户&lt;/p>
&lt;pre>&lt;code>kubectl create clusterrolebinding test:anonymous --clusterrole=cluster-admin --user=system:anonymous
&lt;/code>&lt;/pre>&lt;p>对于正式环境，需要创建一个用户并授权&lt;/p>
&lt;h2 id="heading">&lt;/h2></description></item><item><title>优雅停机</title><link>https://fengzhenbing.github.io/p/%E4%BC%98%E9%9B%85%E5%81%9C%E6%9C%BA/</link><pubDate>Wed, 19 May 2021 08:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/%E4%BC%98%E9%9B%85%E5%81%9C%E6%9C%BA/</guid><description>&lt;h3 id="1-shutdownhook初识">1, ShutdownHook初识&lt;/h3>
&lt;blockquote>
&lt;p>在Java程序中可以通过添加关闭钩子，实现在程序退出时关闭资源、平滑退出的功能。
并且在以下几种场景将调用该钩子&lt;/p>
&lt;ol>
&lt;li>程序正常退出&lt;/li>
&lt;li>使用System.exit()&lt;/li>
&lt;li>终端使用Ctrl+C触发的中断&lt;/li>
&lt;li>系统关闭&lt;/li>
&lt;li>使用Kill pid命令干掉进程&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;p>具体来讲Runtime.addShutdownHook 添加钩子到 ApplicationShutdownHooks中。&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="c1">// Runtime添加钩子（钩子具体来讲就是一个要执行的线程任务）
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">addShutdownHook&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span> &lt;span class="n">hook&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">SecurityManager&lt;/span> &lt;span class="n">sm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getSecurityManager&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">sm&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">sm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">checkPermission&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">RuntimePermission&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;shutdownHooks&amp;#34;&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">ApplicationShutdownHooks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hook&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">// Runtime去除钩子
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">removeShutdownHook&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span> &lt;span class="n">hook&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">SecurityManager&lt;/span> &lt;span class="n">sm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getSecurityManager&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">sm&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">sm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">checkPermission&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">RuntimePermission&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;shutdownHooks&amp;#34;&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">ApplicationShutdownHooks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">remove&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hook&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>再看ApplicationShutdownHooks&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">class&lt;/span> &lt;span class="nc">ApplicationShutdownHooks&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="cm">/* The set of registered hooks */&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">IdentityHashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">hooks&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">static&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Shutdown&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1&lt;/span> &lt;span class="cm">/* shutdown hook invocation order */&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="kc">false&lt;/span> &lt;span class="cm">/* not registered if shutdown in progress */&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="n">Runnable&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">runHooks&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">);&lt;/span>
&lt;span class="n">hooks&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">IdentityHashMap&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;();&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">IllegalStateException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// application shutdown hooks cannot be added if
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// shutdown is in progress.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">hooks&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="nf">ApplicationShutdownHooks&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{}&lt;/span>
&lt;span class="cm">/* Add a new shutdown hook. Checks the shutdown state and the hook itself,
&lt;/span>&lt;span class="cm"> * but does not do any security checks.
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kd">static&lt;/span> &lt;span class="kd">synchronized&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">add&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span> &lt;span class="n">hook&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hooks&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">IllegalStateException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Shutdown in progress&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">hook&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isAlive&lt;/span>&lt;span class="o">())&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">IllegalArgumentException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Hook already running&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">hooks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">containsKey&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hook&lt;/span>&lt;span class="o">))&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">IllegalArgumentException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Hook previously registered&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">hooks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hook&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">hook&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="cm">/* Remove a previously-registered hook. Like the add method, this method
&lt;/span>&lt;span class="cm"> * does not do any security checks.
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kd">static&lt;/span> &lt;span class="kd">synchronized&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">remove&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span> &lt;span class="n">hook&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hooks&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">IllegalStateException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Shutdown in progress&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">hook&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">NullPointerException&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">hooks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">remove&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hook&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="cm">/* Iterates over all application hooks creating a new thread for each
&lt;/span>&lt;span class="cm"> * to run in. Hooks are run concurrently and this method waits for
&lt;/span>&lt;span class="cm"> * them to finish.
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">runHooks&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Collection&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">threads&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">synchronized&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ApplicationShutdownHooks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">threads&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hooks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">keySet&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">hooks&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span> &lt;span class="n">hook&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">threads&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">hook&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span> &lt;span class="n">hook&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">threads&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">hook&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">join&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">ignored&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="2-自定义hooks">2, 自定义hooks&lt;/h3>
&lt;p>往往在应用程序里已经有了一些第三方注册好的hook, 当我们要对将自己自定义的hook放到其他hook之前执行，需要强制干预ApplicationShutdownHooks的hooks，可以通过反射来做&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">String&lt;/span> &lt;span class="n">className&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;java.lang.ApplicationShutdownHooks&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">Class&lt;/span>&lt;span class="o">&amp;lt;?&amp;gt;&lt;/span> &lt;span class="n">clazz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Class&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">forName&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">className&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">Field&lt;/span> &lt;span class="n">field&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">clazz&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getDeclaredField&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;hooks&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">field&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setAccessible&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">// 先反射拿到其他的hook,
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">IdentityHashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">otherHookMap&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">IdentityHashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">&amp;gt;)&lt;/span> &lt;span class="n">field&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">clazz&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">// 将otherHookMap 中 各个hook封装一个延时（比如3s）
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// 再将自定义hook 加入
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">Runtime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getRuntime&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">addShutdownHook&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">(()-&amp;gt;{&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;exec my hook&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="o">}));&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="3-shenyu中应用">3, ShenYu中应用&lt;/h3>
&lt;p>ShenYu项目下线时，会将一些client服务，比如注册中心客户端，优雅停掉。&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ShenyuClientShutdownHook&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// 钩子名称
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">hookNamePrefix&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;ShenyuClientShutdownHook&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">AtomicInteger&lt;/span> &lt;span class="n">hookId&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">AtomicInteger&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">Properties&lt;/span> &lt;span class="n">props&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">AtomicBoolean&lt;/span> &lt;span class="n">delay&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">AtomicBoolean&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//等待加入延时，但是还没有加入的hooks
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">IdentityHashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">delayHooks&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">IdentityHashMap&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;();&lt;/span>
&lt;span class="c1">//已经做了延时的hook
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">IdentityHashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">delayedHooks&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">IdentityHashMap&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;();&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * Add shenyu client shutdown hook.
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * @param result ShenyuClientRegisterRepository
&lt;/span>&lt;span class="cm"> * @param props Properties
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kd">final&lt;/span> &lt;span class="n">ShenyuClientRegisterRepository&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">Properties&lt;/span> &lt;span class="n">props&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">String&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hookNamePrefix&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;-&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">hookId&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">incrementAndGet&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">Runtime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getRuntime&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">addShutdownHook&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">close&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">},&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Add hook {}&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">ShenyuClientShutdownHook&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">props&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">props&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * Delay other shutdown hooks.// 将其他的hooks做延时处理
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">delayOtherHooks&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">delay&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">compareAndSet&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">TakeoverOtherHooksThread&lt;/span> &lt;span class="n">thread&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">TakeoverOtherHooksThread&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * Delay other shutdown hooks thread.
&lt;/span>&lt;span class="cm"> * 延时处理的线程， 1，反射拿到其他hooks
&lt;/span>&lt;span class="cm"> * 2，遍历hooks,通过线程包装原先的hook线程任务，并在其中加3s的延时
&lt;/span>&lt;span class="cm"> * 3，将原先的hook线程任务重新加入到ApplicationShutdownHooks中
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">TakeoverOtherHooksThread&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">Thread&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@SneakyThrows&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">shutdownWaitTime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Integer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">parseInt&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;shutdownWaitTime&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;3000&amp;#34;&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">delayOtherHooksExecTime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Integer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">parseInt&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;delayOtherHooksExecTime&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;2000&amp;#34;&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="n">Class&lt;/span>&lt;span class="o">&amp;lt;?&amp;gt;&lt;/span> &lt;span class="n">clazz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Class&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">forName&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;applicationShutdownHooksClassName&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;java.lang.ApplicationShutdownHooks&amp;#34;&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="n">Field&lt;/span> &lt;span class="n">field&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">clazz&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getDeclaredField&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;applicationShutdownHooksFieldName&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;hooks&amp;#34;&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="n">field&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setAccessible&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">IdentityHashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">hooks&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">IdentityHashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">&amp;gt;)&lt;/span> &lt;span class="n">field&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">clazz&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kt">long&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">delayOtherHooksExecTime&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Iterator&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">iterator&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hooks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">keySet&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">iterator&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="n">iterator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hasNext&lt;/span>&lt;span class="o">();)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Thread&lt;/span> &lt;span class="n">hook&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">iterator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">next&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">hook&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">startsWith&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hookNamePrefix&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>&lt;span class="c1">// 为当前自己自定义的hook 就不做延时
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">continue&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">delayHooks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">containsKey&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hook&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">delayedHooks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">containsKey&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hook&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">continue&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">Thread&lt;/span> &lt;span class="n">delayHook&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>&lt;span class="c1">// 通过线程包装原先的hook线程任务，并在其中加3s的延时
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;sleep {}ms&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">shutdownWaitTime&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MILLISECONDS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">shutdownWaitTime&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">ex&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ex&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">hook&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">run&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">},&lt;/span> &lt;span class="n">hook&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="n">delayHooks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">delayHook&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">delayHook&lt;/span>&lt;span class="o">);&lt;/span>&lt;span class="c1">// 加入的待加入延时集合
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">iterator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">remove&lt;/span>&lt;span class="o">();&lt;/span>&lt;span class="c1">// 从原来的ApplicationShutdownHooks的hooks集合中去掉
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Iterator&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">iterator&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">delayHooks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">keySet&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">iterator&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="n">iterator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hasNext&lt;/span>&lt;span class="o">();)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Thread&lt;/span> &lt;span class="n">delayHook&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">iterator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">next&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">Runtime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getRuntime&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">addShutdownHook&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">delayHook&lt;/span>&lt;span class="o">);&lt;/span>&lt;span class="c1">// 加入到ApplicationShutdownHooks的hooks集合中去掉
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">delayedHooks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">delayHook&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">delayHook&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">iterator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">remove&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;hook {} will sleep {}ms when it start&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">delayHook&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">shutdownWaitTime&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MILLISECONDS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">100&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">hookNamePrefix&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">hookId&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">props&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">delayHooks&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">delayedHooks&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>jvm垃圾回收</title><link>https://fengzhenbing.github.io/p/jvm%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/</link><pubDate>Sun, 14 Mar 2021 00:00:00 +0000</pubDate><guid>https://fengzhenbing.github.io/p/jvm%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/</guid><description>&lt;h2 id="jvm垃圾回收">jvm垃圾回收&lt;/h2>
&lt;h3 id="垃圾回收算法">垃圾回收算法&lt;/h3>
&lt;p>针对 堆内存回收；&lt;/p>
&lt;p>方法区：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>java 8 前 永久区（也参与垃圾回收，一样的算法，省事了，但是有默认最大内存限制，容易oom）&lt;/p>
&lt;/li>
&lt;li>
&lt;p>java 8 彻底抛弃了 永久区，叫元数据区，使用本地内存&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="分代收集理论">分代收集理论&lt;/h4>
&lt;p>新生代&lt;/p>
&lt;p>老年代&lt;/p>
&lt;p>跨代引用： Remember set&lt;/p>
&lt;h4 id="标记清除">标记清除&lt;/h4>
&lt;p>产生内存碎片，内存分配复杂了。 可能需要类似硬盘的 “分区空闲分配链表” 等复杂方式解决&lt;/p>
&lt;p>Cms搜集器在old 区回收时采用， 但是内存碎片达到一定量，会采取一次标记清理。（和稀泥的做法，结合两者，）&lt;/p>
&lt;h4 id="标记复制">标记复制&lt;/h4>
&lt;p>一般用于新生代回收: Serial ParNew 的新生代采用该算法&lt;/p>
&lt;p>Ēden scurvivor scurvivor 8:1:1&lt;/p>
&lt;p>对象存活率较高时，需要更多的复制操作，效率会降低&lt;/p>
&lt;h4 id="标记整理">标记整理&lt;/h4>
&lt;p>用于old区：&lt;/p>
&lt;p>相对于 标记清除， 标记后，需要移动：将存活的对象移动到内存区域的一端。&lt;/p>
&lt;ul>
&lt;li>
&lt;p>移动：增大的延迟，stw时间长些，但解决了内存碎片，内存分配复杂的问题，可以提高吞吐量。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>不移动：降低了延迟，但内存碎片，内存分配复杂， 吞吐量有所下降。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="垃圾回收器">垃圾回收器&lt;/h3></description></item><item><title>pulsar</title><link>https://fengzhenbing.github.io/p/pulsar/</link><pubDate>Tue, 23 Feb 2021 00:00:00 +0000</pubDate><guid>https://fengzhenbing.github.io/p/pulsar/</guid><description>&lt;h2 id="相关概念">相关概念&lt;/h2>
&lt;ul>
&lt;li>计算存储分离&lt;/li>
&lt;li>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/image-20210406220312072.png" alt="image-20210406220312072" />&lt;/li>
&lt;/ul>
&lt;h2 id="安装测试">安装测试&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># 下载&lt;/span>
wget https://mirrors.bfsu.edu.cn/apache/pulsar/pulsar-2.7.1/apache-pulsar-2.7.1-bin.tar.gz
tar xvfz apache-pulsar-2.7.1-bin.tar.gz
&lt;span class="nb">cd&lt;/span> apache-pulsar-2.7.1
&lt;span class="c1"># 单机启动&lt;/span>
bin/pulsar standalone
&lt;span class="c1"># 消费消息&lt;/span>
bin/pulsar-client consume my-topic -s &lt;span class="s2">&amp;#34;first-subscription&amp;#34;&lt;/span>
&lt;span class="c1"># 生产消息&lt;/span>
bin/pulsar-client produce my-topic --messages &lt;span class="s2">&amp;#34;hello-pulsar&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="相关资料">相关资料&lt;/h2>
&lt;p>&lt;a class="link" href="http://pulsar.apache.org/docs/zh-CN/standalone/" target="_blank" rel="noopener"
>官网快速启动&lt;/a>&lt;/p></description></item><item><title>rocketMQ</title><link>https://fengzhenbing.github.io/p/rocketmq/</link><pubDate>Sat, 20 Feb 2021 09:16:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/rocketmq/</guid><description>&lt;h2 id="相关概念">相关概念&lt;/h2>
&lt;p>二代mq, 纯java开发，和kafka无本质区别&lt;/p>
&lt;h2 id="安装测试">安装测试&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># 下载 4.8.0&lt;/span>
wget https://downloads.apache.org/rocketmq/4.8.0/rocketmq-all-4.8.0-bin-release.zip
unzip rocketmq-all-4.8.0-bin-release.zip
&lt;span class="c1">#运行命名服务， 替代kafka的zk&lt;/span>
nohup sh bin/mqnamesrv &lt;span class="p">&amp;amp;&lt;/span>
&lt;span class="c1">#查看日志&lt;/span>
tail -f ~/logs/rocketmqlogs/namesrv.log
&lt;span class="c1">#运行broker&lt;/span>
nohup sh bin/mqbroker -n localhost:9876 &lt;span class="p">&amp;amp;&lt;/span>
&lt;span class="c1">#查看日志&lt;/span>
tail -f ~/logs/rocketmqlogs/broker.log
&lt;span class="c1"># 发送消息&lt;/span>
&lt;span class="nb">export&lt;/span> &lt;span class="nv">NAMESRV_ADDR&lt;/span>&lt;span class="o">=&lt;/span>localhost:9876
sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer
&lt;span class="c1">#消费消息&lt;/span>
sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="相关资料">相关资料&lt;/h2>
&lt;p>&lt;a class="link" href="http://rocketmq.apache.org/docs/quick-start/" target="_blank" rel="noopener"
>官网快速开始&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/apache/rocketmq/tree/master/docs/cn" target="_blank" rel="noopener"
>中文文档&lt;/a>&lt;/p></description></item><item><title>rabbitMQ</title><link>https://fengzhenbing.github.io/p/rabbitmq/</link><pubDate>Fri, 19 Feb 2021 10:16:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/rabbitmq/</guid><description>&lt;h3 id="rabbitmq相关概念">Rabbitmq相关概念&lt;/h3>
&lt;p>一代mq，erlang开发， 改进activemq&lt;/p>
&lt;ul>
&lt;li>Publisher 消息生产者, 返送消息时指定exchange 和routing key, 即可以将消息路由到匹配的queue中&lt;/li>
&lt;li>Routing key&lt;/li>
&lt;li>Binding 通过routing key 将queue和exchange绑定&lt;/li>
&lt;li>Exchange 工具人。。交易所。。代理
&lt;ul>
&lt;li>FanoutExchange: 将消息分发到所有的绑定队列，无routingkey的概念，发送时不指定routing key&lt;/li>
&lt;li>HeadersExchange ：通过添加属性key-value匹配&lt;/li>
&lt;li>DirectExchange: 按照routingkey分发到指定队列&lt;/li>
&lt;li>TopicExchange:多关键字匹配 正则&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Consumer&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://fengzhenbing.github.io/images/blog/image-20210405203826959.png" alt="image-20210405203826959" />&lt;/p>
&lt;h3 id="docker方式安装运行">Docker方式安装运行&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker pull rabbitmq:management
docker run -itd --name rabbitmq-test -e &lt;span class="nv">RABBITMQ_DEFAULT_USER&lt;/span>&lt;span class="o">=&lt;/span>admin -e &lt;span class="nv">RABBITMQ_DEFAULT_PASS&lt;/span>&lt;span class="o">=&lt;/span>admin -p 15672:15672 -p 5672:5672 rabbitmq:management
docker &lt;span class="nb">exec&lt;/span> -it rabbitmq-test /bin/bash
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>康威定律</title><link>https://fengzhenbing.github.io/p/%E5%BA%B7%E5%A8%81%E5%AE%9A%E5%BE%8B/</link><pubDate>Wed, 13 Jan 2021 00:00:00 +0000</pubDate><guid>https://fengzhenbing.github.io/p/%E5%BA%B7%E5%A8%81%E5%AE%9A%E5%BE%8B/</guid><description>&lt;h2 id="康威定律组织决定产品形态">康威定律：组织决定产品形态&lt;/h2>
&lt;h3 id="第一定律">第一定律&lt;/h3>
&lt;p>&lt;strong>组织设计的产品/设计等价于这个组织的沟通结构。&lt;/strong>&lt;/p></description></item><item><title>Synchronized锁</title><link>https://fengzhenbing.github.io/p/synchronized%E9%94%81/</link><pubDate>Tue, 15 Dec 2020 00:00:00 +0000</pubDate><guid>https://fengzhenbing.github.io/p/synchronized%E9%94%81/</guid><description>&lt;h2 id="synchronized">Synchronized&lt;/h2>
&lt;ul>
&lt;li>&lt;strong>Object.wait()&lt;/strong>：释放当前对象锁，并进入阻塞队列(wait set)&lt;/li>
&lt;li>&lt;strong>Object.notify()&lt;/strong>：唤醒当前对象阻塞队列(wait set)里的任一线程（并不保证唤醒哪一个）&lt;/li>
&lt;li>&lt;strong>Object.notifyAll()&lt;/strong>：唤醒当前对象阻塞队列(wait set)里的所有线程, 进到entry set 去竞争锁&lt;/li>
&lt;/ul>
&lt;h2 id="为什么waitnotify和notifyall要与synchronized一起使用">为什么wait,notify和notifyAll要与synchronized一起使用？&lt;/h2>
&lt;p>Wait 只有通过synchronized拿到锁，才能进入wait set&lt;/p>
&lt;p>notify notifyAll只有通过synchronized拿到锁，才能去唤醒 wait set 里线程 到entry set&lt;/p>
&lt;h2 id="object-monitor">object monitor&lt;/h2>
&lt;p>&lt;img src="https://img-blog.csdnimg.cn/2019031712391984.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L211bGluc2VuNzc=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" />&lt;/p>
&lt;h2 id="对象在内存中的存储">对象在内存中的存储&lt;/h2>
&lt;p>&lt;img src="https://img-blog.csdnimg.cn/2019012010560977.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L211bGluc2VuNzc=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" />&lt;/p>
&lt;p>Markword 32位jvm 结构如下： 重量级锁即为 Synchronized 的锁&lt;/p>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/image-20210418232331824.png" alt="image-20210418232331824" />&lt;/p>
&lt;h2 id="锁升级">锁升级&lt;/h2>
&lt;p>参考 &lt;a href="https://mp.weixin.qq.com/s/2yxexZUr5MWdMZ02GCSwdA">https://mp.weixin.qq.com/s/2yxexZUr5MWdMZ02GCSwdA&lt;/a>&lt;/p></description></item><item><title>hazelcast</title><link>https://fengzhenbing.github.io/p/hazelcast/</link><pubDate>Mon, 14 Dec 2020 08:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/hazelcast/</guid><description>&lt;h2 id="安装">安装&lt;/h2>
&lt;h3 id="docker">docker&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker pull hazelcast/hazelcast
docker run -e &lt;span class="nv">HZ_NETWORK_PUBLICADDRESS&lt;/span>&lt;span class="o">=&lt;/span>192.168.3.14:5701 -p 5701:5701 hazelcast/hazelcast:&lt;span class="nv">$HAZELCAST_VERSION&lt;/span>
docker run -e &lt;span class="nv">HZ_NETWORK_PUBLICADDRESS&lt;/span>&lt;span class="o">=&lt;/span>192.168.3.14:5702 -p 5702:5701 hazelcast/hazelcast:&lt;span class="nv">$HAZELCAST_VERSION&lt;/span>
docker run -p 8080:8080 hazelcast/management-center
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>redis应用场景</title><link>https://fengzhenbing.github.io/p/redis%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/</link><pubDate>Sun, 13 Dec 2020 08:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/redis%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/</guid><description>&lt;h2 id="一业务数据缓存">一.业务数据缓存*&lt;/h2>
&lt;p>经典用法。&lt;/p>
&lt;ol>
&lt;li>
&lt;p>通用数据缓存，string，int，list，map等。&lt;/p>
&lt;ul>
&lt;li>验证码等&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>实时热数据，最新500条数据。&lt;/p>
&lt;ul>
&lt;li>如热搜新闻。。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>会话缓存，token缓存等。&lt;/p>
&lt;ul>
&lt;li>spring-session-data-redis sesion共享&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h2 id="二业务数据处理">二.业务数据处理&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>非严格一致性要求的数据&lt;/p>
&lt;ul>
&lt;li>
&lt;p>评论，点击，点赞等。&lt;/p>
&lt;pre>&lt;code>set key 0
incr key // incr readcount::{帖子id} 每阅读一次
get key // get readcount::{帖子id} 获取阅读量
&lt;/code>&lt;/pre>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>业务数据去重&lt;/p>
&lt;ul>
&lt;li>订单处理的幂等校验等。 如订单id放到redis 的set中去重复， bitmap 等&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>业务数据排序&lt;/p>
&lt;ul>
&lt;li>排名，排行榜等。 使用sortedset&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h2 id="三全局一致计数-">三.全局一致计数 *&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>全局流控计数&lt;/p>
&lt;p>多个服务节点使用同一个redis的计数。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>秒杀的库存计算&lt;/p>
&lt;p>和全局计数类似&lt;/p>
&lt;/li>
&lt;li>
&lt;p>抢红包&lt;/p>
&lt;p>和全局计数类似&lt;/p>
&lt;/li>
&lt;li>
&lt;p>全局ID生成&lt;/p>
&lt;p>例如：userId, 直接获取一段userId的最大值，缓存到本地服务慢慢累加，快到了userId的最大值时，再去获取一段，一个用户服务宕机了，也就一小段userId没有用到。 用数据库也可以。&lt;/p>
&lt;pre>&lt;code>set userId 0
incr usrId //返回1
incrby userId 1000 //返回10001
&lt;/code>&lt;/pre>&lt;/li>
&lt;/ol>
&lt;h2 id="四高效统计计数">四.高效统计计数&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>id去重，记录访问ip等&lt;/p>
&lt;p>全局bitmap操作&lt;/p>
&lt;/li>
&lt;li>
&lt;p>UV、PV等访问量==&amp;gt;非严格一致性要求&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="五发布订阅与stream">五.发布订阅与Stream&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>Pub-Sub 模拟队列&lt;/p>
&lt;pre>&lt;code>127.0.0.1:6379&amp;gt; subscribe fzb
Reading messages... (press Ctrl-C to quit)
1) &amp;quot;subscribe&amp;quot;
2) &amp;quot;fzb&amp;quot;
3) (integer) 1
1) &amp;quot;message&amp;quot;
2) &amp;quot;fzb&amp;quot;
3) &amp;quot;fff&amp;quot;
1) &amp;quot;message&amp;quot;
2) &amp;quot;fzb&amp;quot;
3) &amp;quot;ffff&amp;quot;
127.0.0.1:6379&amp;gt; publish fzb fff
(integer) 1
127.0.0.1:6379&amp;gt; publish fzb ffff
(integer) 1
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>Redis Stream 是 Redis 5.0 版本新增加的数据结构。
Redis Stream 主要用于消息队列(MQ，Message Queue)。&lt;/p>
&lt;p>具体可以参考 &lt;a class="link" href="https://www.runoob.com/redis/redis-stream.html" target="_blank" rel="noopener"
>https://www.runoob.com/redis/redis-stream.html&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="六分布式锁">六.分布式锁*&lt;/h2>
&lt;p>1、获取锁&amp;ndash;单个原子性操作&lt;/p>
&lt;ul>
&lt;li>SET dlock my_random_value NX PX 30000&lt;/li>
&lt;/ul>
&lt;pre>&lt;code>127.0.0.1:6379&amp;gt; set myLock 1 NX PX 30000
OK
127.0.0.1:6379&amp;gt; set myLock 1 NX PX 30000
(nil)
&lt;/code>&lt;/pre>&lt;p>2、释放锁&amp;ndash;lua脚本-保证原子性+单线程，从而具有事务性 . =&amp;gt; 因为内存操作是单线程的&lt;/p>
&lt;pre>&lt;code>if redis.call(&amp;quot;get&amp;quot;,KEYS[1]) == ARGV[1] then
return redis.call(&amp;quot;del&amp;quot;,KEYS[1]) else
return 0 end
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>关键点:原子性、互斥、超时&lt;/li>
&lt;/ul>
&lt;p>更多细节：&lt;a class="link" href="https://www.cnblogs.com/yunlongaimeng/p/10266690.html" target="_blank" rel="noopener"
>https://www.cnblogs.com/yunlongaimeng/p/10266690.html&lt;/a>&lt;/p></description></item><item><title>redis基础</title><link>https://fengzhenbing.github.io/p/redis%E5%9F%BA%E7%A1%80/</link><pubDate>Fri, 11 Dec 2020 08:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/redis%E5%9F%BA%E7%A1%80/</guid><description>&lt;h3 id="redis线程">redis线程&lt;/h3>
&lt;p>redis做为一个进程，一直是多线程的。处理io和处理内存的是不同线程。&lt;/p>
&lt;ul>
&lt;li>
&lt;p>io线程&lt;/p>
&lt;ul>
&lt;li>
&lt;p>redis6之前(2020.05)：io处理是单线程&lt;/p>
&lt;/li>
&lt;li>
&lt;p>redis6：io处理多线程，采用nio模型 =&amp;gt; 主要的性能提升点&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>内存处理线程&lt;/p>
&lt;ul>
&lt;li>单线程 =&amp;gt;高性能核心，不用考虑线程调度&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="压测redis-benchmark">压测redis-benchmark&lt;/h2>
&lt;ul>
&lt;li>环境mac 4核8g&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">mokernetdeMac-mini:redis-6.0.9 mokernet$ ./bin/redis-benchmark -n &lt;span class="m">100000&lt;/span> -c &lt;span class="m">32&lt;/span> -t SET,GET,INCR,HSET,LPUSH,MSET -q
SET: 121065.38 requests per second
GET: 118764.84 requests per second
INCR: 117508.81 requests per second
LPUSH: 123001.23 requests per second
HSET: 123915.74 requests per second
MSET &lt;span class="o">(&lt;/span>&lt;span class="m">10&lt;/span> keys&lt;span class="o">)&lt;/span>: 96711.80 requests per second
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="redis的5种基本数据结构">redis的5种基本数据结构&lt;/h2>
&lt;p>&lt;a href="https://redis.io/commands">https://redis.io/commands&lt;/a>&lt;/p>
&lt;h3 id="1字符串string">1.字符串(string)&lt;/h3>
&lt;p>简单来说就是三种:int、string、byte[]&lt;/p>
&lt;p>Redis中字符串类型的value最多可以容纳的数据长度是512M&lt;/p>
&lt;pre>&lt;code>set/get/setnx/getset/del/exists/append incr/decr/incrby/decrby
&lt;/code>&lt;/pre>&lt;h3 id="2散列hash">2.散列(hash)&lt;/h3>
&lt;p>Redis中的Hash类型可以看成具有String key 和String value的map容器。&lt;/p>
&lt;pre>&lt;code>hset/hget/hmset/hmget/hgetall/hdel/hincrby hexists/hlen/hkeys/hvals
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>hmset 相对于hset可一次设置多个键值对&lt;/li>
&lt;li>hmget 相对于hget可一次获取多个键的值&lt;/li>
&lt;/ul>
&lt;h3 id="3列表list">3.列表(list)&lt;/h3>
&lt;p>java的LinkedList&lt;/p>
&lt;p>在Redis中，List类型是按照插入顺序排序的字符串链表。和数据结构中的普通链表 一 样，我们可以在其头部(Left)和尾部(Right)添加新的元素。在插入时，如果该键并不存 在，Redis将为该键创建一个新的链表。与此相反，如果链表中所有的元素均被移除， 那么该键也将会被从数据库中删除。&lt;/p>
&lt;pre>&lt;code>lpush/rpush/lrange/lpop/rpop
&lt;/code>&lt;/pre>&lt;h3 id="4集合set">4.集合(set)&lt;/h3>
&lt;p>java的set，不重复的list&lt;/p>
&lt;p>在redis中，可以将Set类型看作是没有排序的字符集合，和List类型一样，我们也可以 在该类型的数值上执行添加、删除和判断某一元素是否存在等操作。这些操作的时间复 杂度为O(1),即常量时间内完成依次操作。&lt;/p>
&lt;p>和List类型不同的是，Set集合中不允许出现重复的元素。&lt;/p>
&lt;pre>&lt;code>sadd/srem/smembers/sismember 类比java中set的add, remove, all, contains,
spop key [count] 随机返回集合中一个或多个 移除
SRANDMEMBER key [count] 返回集合中一个或多个随机数，不移除, 抽奖
sdiff/sinter/sunion 集合求差集，求交集，求并集
&lt;/code>&lt;/pre>&lt;h3 id="5有序集合sorted-set">5.有序集合(sorted set)&lt;/h3>
&lt;p>按权重排序&lt;/p>
&lt;p>sortedset在set基础上给每个元素加了个分数score。&lt;/p>
&lt;p>redis 正是通过分数来为集合的成员进行从小到大的排序。sortedset中分数是可以重复的。&lt;/p>
&lt;pre>&lt;code>zadd key score member score2 member2... : 将成员以及该成员的分数存放到sortedset中
zscore key member : 返回指定成员的分数
zcard key : 获取集合中成员数量
zrem key member [member...] : 移除集合中指定的成员，可以指定多个成员
zrange key start end [withscores] : 获取集合中脚注为start-end的成员，[withscores]参数表明返回的成员 包含其分数
zrevrange key start stop [withscores] : 按照分数从大到小的顺序返回索引从start到stop之间的所有元素 (包含两端的元素)
zremrangebyrank key start stop : 按照排名范围删除元素
&lt;/code>&lt;/pre>&lt;h2 id="redis高级数据结构">redis高级数据结构&lt;/h2>
&lt;h3 id="1bitmaps">1.Bitmaps&lt;/h3>
&lt;p>bitmaps不是一个真实的数据结构。而是String类型上的一组面向bit操作的集合。由于 strings是二进制安全的blob，并且它们的最大长度是512m，所以bitmaps能最大设置 2^32个不同的bit。&lt;/p>
&lt;pre>&lt;code>setbit/getbit/bitop/bitcount/bitpos
&lt;/code>&lt;/pre>&lt;p>可用作集中式的冥等去重 数据压缩在字节位上，极大的节约了空间&lt;/p>
&lt;h3 id="2hyperloglog">2.HyperLogLog&lt;/h3>
&lt;p>Redis 是用来做基数统计的算法，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定 的、并且是很小的。&lt;/p>
&lt;p>在 Redis 里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基 数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。&lt;/p>
&lt;p>但是，因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。&lt;/p>
&lt;pre>&lt;code>pfadd 添加
pfcount 获得基数值
pfmerge 合并多个key
&lt;/code>&lt;/pre>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">127.0.0.1:6379&amp;gt; pfadd pf1 &lt;span class="m">1&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">4&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">5&lt;/span>
&lt;span class="o">(&lt;/span>integer&lt;span class="o">)&lt;/span> &lt;span class="m">1&lt;/span>
127.0.0.1:6379&amp;gt; pfcount pf1
&lt;span class="o">(&lt;/span>integer&lt;span class="o">)&lt;/span> &lt;span class="m">4&lt;/span>
127.0.0.1:6379&amp;gt; pfadd pf2 &lt;span class="m">3&lt;/span> &lt;span class="m">4&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">6&lt;/span> &lt;span class="m">7&lt;/span>
&lt;span class="o">(&lt;/span>integer&lt;span class="o">)&lt;/span> &lt;span class="m">1&lt;/span>
127.0.0.1:6379&amp;gt; pfcount pf2
&lt;span class="o">(&lt;/span>integer&lt;span class="o">)&lt;/span> &lt;span class="m">5&lt;/span>
127.0.0.1:6379&amp;gt; pfmerge pf3 pf1 pf2
OK
127.0.0.1:6379&amp;gt; pfcount pf3
&lt;span class="o">(&lt;/span>integer&lt;span class="o">)&lt;/span> &lt;span class="m">6&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>应用场景说明：&lt;/p>
&lt;ul>
&lt;li>基数不大，数据量不大就用不上，会有点大材小用浪费空间&lt;/li>
&lt;li>有局限性，就是只能统计基数数量，而没办法去知道具体的内容是什么&lt;/li>
&lt;li>和bitmap相比，属于两种特定统计情况，简单来说，HyperLogLog 去重比 bitmap 方便很多&lt;/li>
&lt;li>一般可以bitmap和hyperloglog配合使用，bitmap标识哪些用户活跃，hyperloglog计数&lt;/li>
&lt;/ul>
&lt;p>一般使用：&lt;/p>
&lt;ul>
&lt;li>统计注册 IP 数&lt;/li>
&lt;li>统计每日访问 IP 数&lt;/li>
&lt;li>统计页面实时 UV 数&lt;/li>
&lt;li>统计在线用户数&lt;/li>
&lt;li>统计用户每天搜索不同词条的个数&lt;/li>
&lt;/ul>
&lt;h3 id="3geo">3.GEO&lt;/h3>
&lt;pre>&lt;code>geoadd/geohash/geopos/geodist/georadius/georadiusbymember
&lt;/code>&lt;/pre>&lt;p>Redis的GEO特性在 Redis3.2版本中推出，这个功能可以将用户给定的地理位置(经 度和纬度)信息储存起来，并对这些信息进行操作。&lt;/p>
&lt;h2 id="redis-lua">Redis Lua&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>类比openrestry = nginx + lua jit&lt;/p>
&lt;/li>
&lt;li>
&lt;p>类似于数据库的存储过程，mongodb的js脚本&lt;/p>
&lt;/li>
&lt;li>
&lt;p>redis内存操作的单线程 使得一段lua脚本之心具有：&lt;strong>原子性&lt;/strong>，操作不会被打断，保证了&lt;strong>事务&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>直接执行
eval &amp;ldquo;return&amp;rsquo;hello java'&amp;rdquo; 0
eval &amp;ldquo;redis.call(&amp;lsquo;set&amp;rsquo;,KEYS[1],ARGV[1])&amp;rdquo; 1 lua-key lua-value&lt;/p>
&lt;pre>&lt;code>127.0.0.1:6379&amp;gt; eval &amp;quot;return'hello java'&amp;quot; 0
&amp;quot;hello java&amp;quot;
127.0.0.1:6379&amp;gt; eval &amp;quot;redis.call('set',KEYS[1],ARGV[1])&amp;quot; 1 ff zz
(nil)
127.0.0.1:6379&amp;gt; get ff
&amp;quot;zz&amp;quot;
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>预编译
script load script脚本片段
返回一个SHA-1签名 shastring
evalsha shastring keynum [key1 key2 key3 &amp;hellip;] [param1 param2 param3 &amp;hellip;]&lt;/p>
&lt;pre>&lt;code>127.0.0.1:6379&amp;gt; script load &amp;quot;redis.call('set',KEYS[1],ARGV[1])&amp;quot;
&amp;quot;7cfb4342127e7ab3d63ac05e0d3615fd50b45b06&amp;quot;
127.0.0.1:6379&amp;gt; evalsha 7cfb4342127e7ab3d63ac05e0d3615fd50b45b06 1 fff zzz
(nil)
127.0.0.1:6379&amp;gt; get fff
&amp;quot;zzz&amp;quot;
&lt;/code>&lt;/pre>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="redis-pipeline">redis pipeline&lt;/h2>
&lt;p>使用管道一次执行多个命令，多个命令的结果一起返回，减少每个命令来回建立链接，来回响应的时间。&lt;/p>
&lt;p>&lt;a href="https://redis.io/topics/pipelining">https://redis.io/topics/pipelining&lt;/a>&lt;/p>
&lt;h2 id="redis事务">redis事务&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>开启事务:multi&lt;/p>
&lt;/li>
&lt;li>
&lt;p>命令入队&lt;/p>
&lt;/li>
&lt;li>
&lt;p>执行事务:exec&lt;/p>
&lt;/li>
&lt;li>
&lt;p>撤销事务:discard&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Watch 监控事务： watch 一个key，发生变化则事务失败&lt;/p>
&lt;/li>
&lt;li>
&lt;p>unwatch 取消监听&lt;/p>
&lt;/li>
&lt;/ul>
&lt;pre>&lt;code>127.0.0.1:6379&amp;gt; multi
OK
127.0.0.1:6379&amp;gt; set ff ff
QUEUED
127.0.0.1:6379&amp;gt; set fff fff
QUEUED
127.0.0.1:6379&amp;gt; exec
1) OK
2) OK
&lt;/code>&lt;/pre>&lt;h2 id="redis管道">redis管道&lt;/h2>
&lt;h2 id="redis备份恢复机制">redis备份恢复机制&lt;/h2>
&lt;h3 id="rdb方式">RDB方式&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>快照恢复，类似mysql的frm.等数据：备份当前瞬间 Redis 在内存中的数据记录&lt;/p>
&lt;/li>
&lt;li>
&lt;p>save后在数据目录生成dump.rdb&lt;/p>
&lt;/li>
&lt;li>
&lt;p>bgsave 异步执行备份&lt;/p>
&lt;p>&lt;img src="http://pics5.baidu.com/feed/1c950a7b02087bf43b4490d50ac25f2a11dfcf7e.jpeg?token=22f387ba78130c6115420059481b2393&amp;amp;s=EF48A15796784D8816E1D9EB03007024" alt="img" />&lt;/p>
&lt;/li>
&lt;li>
&lt;p>恢复：将备份文件 (dump.rdb) 移动到 redis 数据目录并启动服务即可&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>redis.conf中&lt;/p>
&lt;pre>&lt;code>#Redis默认配置文件中提供了三个备份条件： ##指定在多长时间内，有多少次更新操作，就将数据同步到数据文件，可以多个条件配合
save 900 1
save 300 10
save 60 10000
&lt;/code>&lt;/pre>&lt;h3 id="aof方式">AOF方式&lt;/h3>
&lt;ul>
&lt;li>追加文件（Append-Only File，AOF） 类比mysql的binlog&lt;/li>
&lt;li>配置为 always，其含义为当 Redis 执行 命令的时候，则同时同步到 AOF 文件，这样会使得 Redis 同步刷新 AOF 文件，造成 缓慢。而采用 evarysec 则代表每秒同步一次命令到 AOF 文件&lt;/li>
&lt;/ul>
&lt;pre>&lt;code>appendfilename &amp;quot;appendonly.aof&amp;quot;
# appendfsync always
appendfsync everysec
# appendfsync no......
&lt;/code>&lt;/pre>&lt;p>&lt;img src="http://pics5.baidu.com/feed/b17eca8065380cd7df69859ba056a5325982816c.jpeg?token=a060f459d81c409c3d6c7208d2118888&amp;amp;s=AF4AA5574ED85CC841D04BE60300A036" alt="img" />&lt;/p>
&lt;ul>
&lt;li>恢复：自动加载&lt;/li>
&lt;/ul>
&lt;h2 id="redis性能优化">redis性能优化&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">slowlog get &lt;span class="m">10&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="几个缓存问题">几个缓存问题&lt;/h2>
&lt;h3 id="缓存穿透">缓存穿透&lt;/h3>
&lt;ul>
&lt;li>现象：key对应的数据在数据源并不存在，每次针对此key的请求从缓存获取不到，请求都会到数据源，从而可能压垮数据源。比如用一个不存在的用户id获取用户信息，不论缓存还是数据库都没有，若黑客利用此漏洞进行攻击可能压垮数据库&lt;/li>
&lt;li>解决：
&lt;ul>
&lt;li>采用布隆过滤器：将所有可能存在的数据哈希到一个足够大的bitmap中，一个一定不存在的数据会被 这个bitmap拦截掉，从而避免了对底层存储系统的查询压力，详见https://www.cnblogs.com/rinack/p/9712477.html&lt;/li>
&lt;li>直接缓存空结果：如果一个查询返回的数据为空，仍然把这个空结果进行缓存。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="缓存击穿">缓存击穿&lt;/h3>
&lt;ul>
&lt;li>现象：key对应的数据存在，但在redis中过期，此时若有大量并发请求过来，这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端DB压垮。&lt;/li>
&lt;li>解决：使用&lt;strong>互斥分布式锁&lt;/strong>进行从DB加载数据，其他的请求继续重试缓存。使用锁可能会死锁、线程池阻塞等问题，针对高热点key，最好是在并发量最小的时候，写定时器更新key的过期时间&lt;/li>
&lt;/ul>
&lt;h3 id="缓存雪崩">缓存雪崩&lt;/h3>
&lt;ul>
&lt;li>现象：当缓存服务器重启或者大量缓存集中在某一个时间段失效，这样在失效的时候，也会给后端系统(比如DB)带来很大压力。与缓存击穿的区别在于这里针对很多key缓存，前者则是某一个key。&lt;/li>
&lt;li>解决：
&lt;ul>
&lt;li>最简单尽量将过期时间分散开来：可以在原有的失效时间基础上增加一个随机值，比如1-5分钟随机，&lt;/li>
&lt;li>设置过期标志更新缓存:
&lt;ul>
&lt;li>1，新加一个缓存key的标记。缓存数据key的value时，同时缓存key_sign, key_sign的过期时间小于key的过期时间。&lt;/li>
&lt;li>2 在查询缓存时，先判断key_sign是否过期，a，如果过期，先直接返回value，再启用异步线程去更新key_sign以及加载db到key的value,重新设置两个的过期时间。b. 没有过期，直接返回value&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul></description></item><item><title>01.gateway整体逻辑</title><link>https://fengzhenbing.github.io/p/01.gateway%E6%95%B4%E4%BD%93%E9%80%BB%E8%BE%91/</link><pubDate>Thu, 10 Dec 2020 08:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/01.gateway%E6%95%B4%E4%BD%93%E9%80%BB%E8%BE%91/</guid><description>&lt;h2 id="gateway整体逻辑">gateway整体逻辑&lt;/h2>
&lt;h3 id="1流程图">1.流程图&lt;/h3>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/image.png" alt="image" />&lt;/p>
&lt;h3 id="2几个关键的类">2.&lt;strong>几个关键的类&lt;/strong>&lt;/h3>
&lt;ul>
&lt;li>org.springframework.web.reactive.DispatcherHandler: 请求分发处理器；&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;ul>
&lt;li>Spring WebFlux 的访问入口；&lt;/li>
&lt;li>类似于spring mvc DispatcherServlet,可以类比spring mvc 接收到请求;&lt;/li>
&lt;li>DispatcherHandler匹配 HandlerMapping此处会匹配到scg的RoutePredicateHandlerMapping&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;ul>
&lt;li>
&lt;p>org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping：HandlerMapping的实现；&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>通过RouteLocator匹配 Route: getHandlerInternal方法调用lookupRoute()方法，通过routeLocator获取所有配置的route,通过里面的Predicate配置来遍历判断找出符合的Route&lt;/li>
&lt;li>getHandlerInternal中返回FilteringWebHandler&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>org.springframework.cloud.gateway.handler.FilteringWebHandler: WebHandler的实现；&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>FilteringWebHandler被RoutePredicateHandlerMapping返回后，在DispatcherHandler中被SimpleHandlerAdapter执行handle方法；&lt;/li>
&lt;li>责任链模式：获取Route的GatewayFilter数组，创建DefaultGatewayFilterChain的过滤链；链式调用GatewayFilter&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;/li>
&lt;/ul>
&lt;h3 id="3项目结构">3.项目结构&lt;/h3>
&lt;p>核心module为spring-cloud-gateway-server&lt;/p>
&lt;ul>
&lt;li>actuate: 实现springboot actuator的端点，暴露route filter predicate等信息&lt;/li>
&lt;li>config: 使用springboot的配置注解的各类配置类&lt;/li>
&lt;li>discover：通过注册中心获取路由Route的核心功能配置类及实现类&lt;/li>
&lt;li>event：实现ApplicationEvent的事件类，例如路由刷新事件RefreshRoutesEvent&lt;/li>
&lt;li>filter: 包含特定路由的GatewayFilterFactory，GatewayFiler以及全局的GlobalFilter&lt;/li>
&lt;li>handler: 包含匹配route的断言工厂AbstractRoutePredicateFactory的所有默认实现，以及核心类FilteringWebHandler及RoutePredicateHandlerMapping&lt;/li>
&lt;li>route：路由的定义类，及路由定位类CachingRouteLocator的所有实现，及路由定义定位类CompositeRouteDefinitionLocator的所有实现，路由存储接口RouteDefinitionRepository及其所有实现&lt;/li>
&lt;li>support：工具类；如HTTP协议处理，组件名处理，日期转换等&lt;/li>
&lt;/ul></description></item><item><title>02.reactor响应式编程学习</title><link>https://fengzhenbing.github.io/p/02.reactor%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/</link><pubDate>Thu, 10 Dec 2020 08:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/02.reactor%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/</guid><description>&lt;h2 id="reactor-使用">reactor 使用&lt;/h2>
&lt;p>![image (1)](&lt;a href="https://gitee.com/fengzhenbing/picgo/raw/master/image">https://gitee.com/fengzhenbing/picgo/raw/master/image&lt;/a> (1).png)&lt;/p>
&lt;h4 id="webflux-模块的名称是-spring-webflux名称中的-flux-来源于-reactor-中的类-flux">Webflux 模块的名称是 spring-webflux，名称中的 Flux 来源于 Reactor 中的类 Flux。&lt;/h4>
&lt;p>Reactor 两个核心概念做一些澄清，一个是Mono，另一个是Flux&lt;/p>
&lt;ul>
&lt;li>Flux ：表示的是包含 0 到 N 个元素的异步序列。包含三个类型&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;ul>
&lt;li>正常的包含元素的消息&lt;/li>
&lt;li>序列结束的消息&lt;/li>
&lt;li>序列出错的消息&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;ul>
&lt;li>Mono： 表示的是包含 0 或者 1 个元素的异步序列。该序列中同样可以包含与 Flux 相同的三种类型的消息通知。
示例代码：&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;ul>
&lt;li>&lt;a href="https://github.com/fengzhenbing/spring-cloud-gateway-demo/blob/master/demo-gateway/src/main/java/org/fzb/demo/gateway/RectorController.java">https://github.com/fengzhenbing/spring-cloud-gateway-demo/blob/master/demo-gateway/src/main/java/org/fzb/demo/gateway/RectorController.java&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote></description></item><item><title>03.scg NettyWebServer启动过程</title><link>https://fengzhenbing.github.io/p/03.scg-nettywebserver%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/</link><pubDate>Thu, 10 Dec 2020 08:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/03.scg-nettywebserver%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/</guid><description>&lt;h2 id="scg-nettywebserver启动过程">scg NettyWebServer启动过程&lt;/h2>
&lt;p>spring cloud gateway(下面简称scg)依赖spring webflux, 而spring webflux依赖于reactor-netty,也就是scg启动过程中最终会启动netty做为服务器。
springboot中定义一下几种服务器：&lt;/p>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/webserver.png" alt="webserver" />&lt;/p>
&lt;h3 id="1-启动reactivewebserverapplicationcontext">1 启动ReactiveWebServerApplicationContext&lt;/h3>
&lt;p>从springboot启动开始分析&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">SpringApplication&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">run&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">GatewayApplication&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>设置webApplicationType的值：REACTIVE还是servlet的。&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="nf">SpringApplication&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ResourceLoader&lt;/span> &lt;span class="n">resourceLoader&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Class&lt;/span>&lt;span class="o">&amp;lt;?&amp;gt;...&lt;/span> &lt;span class="n">primarySources&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">resourceLoader&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">resourceLoader&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">Assert&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">notNull&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">primarySources&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;PrimarySources must not be null&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">primarySources&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">LinkedHashSet&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;(&lt;/span>&lt;span class="n">Arrays&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">asList&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">primarySources&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">webApplicationType&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">WebApplicationType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">deduceFromClasspath&lt;/span>&lt;span class="o">();&lt;/span>&lt;span class="c1">//fzb 通过类路径中类，推测web应用类型：REACTIVE还是servlet的。
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">setInitializers&lt;/span>&lt;span class="o">((&lt;/span>&lt;span class="n">Collection&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">getSpringFactoriesInstances&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ApplicationContextInitializer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="n">setListeners&lt;/span>&lt;span class="o">((&lt;/span>&lt;span class="n">Collection&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">getSpringFactoriesInstances&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ApplicationListener&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">mainApplicationClass&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">deduceMainApplicationClass&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>再看deduceFromClasspath方法：判断DispatcherHandler存在还是DispatcherServlet存在&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">static&lt;/span> &lt;span class="n">WebApplicationType&lt;/span> &lt;span class="nf">deduceFromClasspath&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>&lt;span class="c1">//fzb 判断DispatcherHandler存在还是DispatcherServlet存在
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">ClassUtils&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isPresent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">WEBFLUX_INDICATOR_CLASS&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="n">ClassUtils&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isPresent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">WEBMVC_INDICATOR_CLASS&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="n">ClassUtils&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isPresent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">JERSEY_INDICATOR_CLASS&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">WebApplicationType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">REACTIVE&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span> &lt;span class="n">className&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">SERVLET_INDICATOR_CLASSES&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">ClassUtils&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isPresent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">className&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">WebApplicationType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">NONE&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">WebApplicationType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SERVLET&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>在此scg项目有DispatcherHandler类，所以是REACTIVE，响应式的。
下面接着创建相应的响应式容器&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">protected&lt;/span> &lt;span class="n">ConfigurableApplicationContext&lt;/span> &lt;span class="nf">createApplicationContext&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Class&lt;/span>&lt;span class="o">&amp;lt;?&amp;gt;&lt;/span> &lt;span class="n">contextClass&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">applicationContextClass&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">contextClass&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">webApplicationType&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>&lt;span class="c1">//fzb 根据webApplicationType类型创建不同的context容器
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="n">SERVLET&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">contextClass&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Class&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">forName&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">DEFAULT_SERVLET_WEB_CONTEXT_CLASS&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="n">REACTIVE&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">contextClass&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Class&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">forName&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">DEFAULT_REACTIVE_WEB_CONTEXT_CLASS&lt;/span>&lt;span class="o">);&lt;/span>&lt;span class="c1">//fzb scg创建的容器
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">break&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">contextClass&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Class&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">forName&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">DEFAULT_CONTEXT_CLASS&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">ClassNotFoundException&lt;/span> &lt;span class="n">ex&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">IllegalStateException&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="s">&amp;#34;Unable create a default ApplicationContext, please specify an ApplicationContextClass&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ex&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">ConfigurableApplicationContext&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">BeanUtils&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">instantiateClass&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">contextClass&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>各类容器选择总结&lt;/p>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/context.png" alt="context" />&lt;/p>
&lt;h3 id="2--reactivewebserverapplicationcontext刷新">2 ReactiveWebServerApplicationContext刷新&lt;/h3>
&lt;p>先创建了
org.springframework.boot.autoconfigure.web.reactive.ReactiveWebServerFactoryAutoConfiguration中配置了EmbeddedNetty，初始化了NettyReactiveWebServerFactory&lt;/p>
&lt;p>ReactiveWebServerApplicationContext容器刷新时通过ReactiveWebServerFactory创建WebServerManager&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">
&lt;span class="kd">protected&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">onRefresh&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">super&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">onRefresh&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">createWebServer&lt;/span>&lt;span class="o">();&lt;/span>&lt;span class="c1">//fzb 创建WebServerManager
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Throwable&lt;/span> &lt;span class="n">ex&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ApplicationContextException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Unable to start reactive web server&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ex&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">createWebServer&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>&lt;span class="c1">//fzb 通过ReactiveWebServerFactory创建WebServerManager
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">WebServerManager&lt;/span> &lt;span class="n">serverManager&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">serverManager&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">serverManager&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">String&lt;/span> &lt;span class="n">webServerFactoryBeanName&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getWebServerFactoryBeanName&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">ReactiveWebServerFactory&lt;/span> &lt;span class="n">webServerFactory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getWebServerFactory&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">webServerFactoryBeanName&lt;/span>&lt;span class="o">);&lt;/span>&lt;span class="c1">//fzb 获取EmbeddedNetty配置的ReactiveWebServerFactory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">lazyInit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getBeanFactory&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getBeanDefinition&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">webServerFactoryBeanName&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">isLazyInit&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">serverManager&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">WebServerManager&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">webServerFactory&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">getHttpHandler&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">lazyInit&lt;/span>&lt;span class="o">);&lt;/span>&lt;span class="c1">//fzb 创建
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">getBeanFactory&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">registerSingleton&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;webServerGracefulShutdown&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="n">WebServerGracefulShutdownLifecycle&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">serverManager&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="n">getBeanFactory&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">registerSingleton&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;webServerStartStop&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="n">WebServerStartStopLifecycle&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">serverManager&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">initPropertySources&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>再看WebServerManager初始化时，再通过ReactiveWebServerFactory 初始化创建NettyWebServer&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">WebServerManager&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ReactiveWebServerApplicationContext&lt;/span> &lt;span class="n">applicationContext&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ReactiveWebServerFactory&lt;/span> &lt;span class="n">factory&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">Supplier&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">HttpHandler&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">handlerSupplier&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">lazyInit&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">applicationContext&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">applicationContext&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">Assert&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">notNull&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;Factory must not be null&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">handler&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">DelayedInitializationHttpHandler&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">handlerSupplier&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">lazyInit&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">webServer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">factory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getWebServer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">handler&lt;/span>&lt;span class="o">);&lt;/span>&lt;span class="c1">//fzb scg中创建NettyWebServer
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>下面是ReactiveWebServerFactory初始化创建NettyWebServer的过程，实际是创建reactor.netty 的HttpServer，通过适配器模式ReactorHttpHandlerAdapter，适配为NettyWebServer 返回&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java"> &lt;span class="kd">public&lt;/span> &lt;span class="n">WebServer&lt;/span> &lt;span class="nf">getWebServer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">HttpHandler&lt;/span> &lt;span class="n">httpHandler&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">HttpServer&lt;/span> &lt;span class="n">httpServer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">createHttpServer&lt;/span>&lt;span class="o">();&lt;/span>&lt;span class="c1">//fzb 创建reactor.netty 的HttpServer
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">ReactorHttpHandlerAdapter&lt;/span> &lt;span class="n">handlerAdapter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ReactorHttpHandlerAdapter&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">httpHandler&lt;/span>&lt;span class="o">);&lt;/span>&lt;span class="c1">//通过ReactorHttpHandlerAdapter适配器模式适配
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">NettyWebServer&lt;/span> &lt;span class="n">webServer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">NettyWebServer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">httpServer&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">handlerAdapter&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lifecycleTimeout&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">getShutdown&lt;/span>&lt;span class="o">());&lt;/span>&lt;span class="c1">//HttpServer 适配为NettyWebServer
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">webServer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setRouteProviders&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">routeProviders&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">webServer&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="3--netty的serverbootstrap启动">3 Netty的ServerBootstrap启动&lt;/h3>
&lt;p>继续跟进createHttpServer()&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">private&lt;/span> &lt;span class="n">HttpServer&lt;/span> &lt;span class="nf">createHttpServer&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">HttpServer&lt;/span> &lt;span class="n">server&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">HttpServer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="o">();&lt;/span>&lt;span class="c1">//fzb 创建httpServer
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">....&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>跟进HttpServer.create()，如下为&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">HttpServer&lt;/span> &lt;span class="nf">create&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">HttpServerBind&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">INSTANCE&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>查看HttpServerBind初始化过程，实际最终创建的是TcpServer&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">TcpServer&lt;/span> &lt;span class="n">DEFAULT_TCP_SERVER&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TcpServer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="o">();&lt;/span>&lt;span class="c1">// 创建TcpServer
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="n">HttpServerBind&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">DEFAULT_TCP_SERVER&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>再跟进TcpServer&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">TcpServer&lt;/span> &lt;span class="nf">create&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">TcpServerBind&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">INSTANCE&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>千呼万唤始出来 TcpServerBind,&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">TcpServerBind&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">serverBootstrap&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">createServerBootstrap&lt;/span>&lt;span class="o">();&lt;/span>&lt;span class="c1">//创建启动Netty的服务端serverBootstrap
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">BootstrapHandlers&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">channelOperationFactory&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">serverBootstrap&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TcpUtils&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">TCP_OPS&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>至此找到了scg启动时最终启动的netty server.&lt;/p>
&lt;p>HttpServer为reactor netty项目中的
参考 Reactor Netty参考指南 &lt;a href="https://projectreactor.io/docs/netty/release/reference/index.html">https://projectreactor.io/docs/netty/release/reference/index.html&lt;/a>&lt;/p></description></item><item><title>04.scg 一次请求的执行过程</title><link>https://fengzhenbing.github.io/p/04.scg-%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B/</link><pubDate>Thu, 10 Dec 2020 08:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/04.scg-%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B/</guid><description>&lt;h2 id="一次请求的执行过程">一次请求的执行过程&lt;/h2></description></item><item><title>05.route路由的配置加载</title><link>https://fengzhenbing.github.io/p/05.route%E8%B7%AF%E7%94%B1%E7%9A%84%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/</link><pubDate>Thu, 10 Dec 2020 08:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/05.route%E8%B7%AF%E7%94%B1%E7%9A%84%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/</guid><description>&lt;h2 id="route路由的配置加载">route路由的配置加载&lt;/h2>
&lt;hr>
&lt;p>主要在sprng-cloud-gateway-server的route包定义路由相关的定义，构建和加载&lt;/p>
&lt;p>![路由](&lt;a href="https://gitee.com/fengzhenbing/picgo/raw/master/image">https://gitee.com/fengzhenbing/picgo/raw/master/image&lt;/a> (2).png)&lt;/p>
&lt;h3 id="0相关配置">0.相关配置&lt;/h3>
&lt;ul>
&lt;li>通过springboot spi方式，springboot会启动spring.factories中配置的
org.springframework.cloud.gateway.discovery.GatewayDiscoveryClientAutoConfiguration&lt;/li>
&lt;/ul>
&lt;pre>&lt;code class="language-properties" data-lang="properties">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
org.springframework.cloud.gateway.config.GatewayAutoConfiguration,\
org.springframework.cloud.gateway.discovery.GatewayDiscoveryClientAutoConfiguration,\
...
&lt;/code>&lt;/pre>&lt;h3 id="1路由定义">1.路由定义&lt;/h3>
&lt;ul>
&lt;li>路由定义RouteDefinition&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">RouteDefinition&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@NotEmpty&lt;/span>
&lt;span class="nd">@Valid&lt;/span>&lt;span class="c1">//fzb 断言定义数组
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">PredicateDefinition&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">predicates&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;();&lt;/span>
&lt;span class="nd">@Valid&lt;/span>&lt;span class="c1">//fzb 过滤器定义数组
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">FilterDefinition&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">filters&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;();&lt;/span>
&lt;span class="nd">@NotNull&lt;/span>&lt;span class="c1">//fzb 路由路径
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="n">URI&lt;/span> &lt;span class="n">uri&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>路由定义定位器&lt;/li>
&lt;/ul>
&lt;p>获取路由的定义，负责读取上述路由定义配置 RouteDefinition，最终会通过路由定义生成路由&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="nc">RouteDefinitionLocator&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//fzb 获取路由定义对象
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Flux&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">RouteDefinition&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">getRouteDefinitions&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>有以下实现：&lt;/p>
&lt;p>![image (3)](&lt;a href="https://gitee.com/fengzhenbing/picgo/raw/master/image">https://gitee.com/fengzhenbing/picgo/raw/master/image&lt;/a> (3).png)&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>CachingRouteDefinitionLocator: 它包装了CompositeRouteDefinitionLocator,缓存路由定义RouteDefinition列表&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;/code>&lt;/pre>&lt;/div>&lt;/blockquote>
&lt;p>public class CachingRouteDefinitionLocator
implements RouteDefinitionLocator, ApplicationListener&lt;!-- raw HTML omitted --> {//fzb 事件监听RefreshRoutesEvent&lt;/p>
&lt;pre>&lt;code>private static final String CACHE_KEY = &amp;quot;routeDefs&amp;quot;;
private final RouteDefinitionLocator delegate;
//fzb 路由定义flux
private final Flux&amp;lt;RouteDefinition&amp;gt; routeDefinitions;
//fzb 内存缓存RouteDefinition
private final Map&amp;lt;String, List&amp;gt; cache = new ConcurrentHashMap&amp;lt;&amp;gt;();
...
//fzb 监听到路由刷新事件，重新获取路由并缓存到cache
@Override
public void onApplicationEvent(RefreshRoutesEvent event) {
fetch().materialize().collect(Collectors.toList())
.doOnNext(routes -&amp;gt; cache.put(CACHE_KEY, routes)).subscribe();
}
&lt;/code>&lt;/pre>
&lt;p>&amp;hellip;
}&lt;/p>
&lt;pre>&lt;code> &amp;gt; * CompositeRouteDefinitionLocator:
&amp;gt; 遍历执行所有RouteDefinitionLocator的查找路由定义方法,将找到的路由定义合并； 组合多种 RouteDefinitionLocator 的实现，为 routeDefinitions提供统一入口
​```java
public class CompositeRouteDefinitionLocator implements RouteDefinitionLocator {
...
//fzb 组合多个路由定义定位器RouteDefinitionLocator
private final Flux&amp;lt;RouteDefinitionLocator&amp;gt; delegates;
// fzb 路由定义的id 生成器，默认UUID
private final IdGenerator idGenerator;
...
public CompositeRouteDefinitionLocator(Flux&amp;lt;RouteDefinitionLocator&amp;gt; delegates,
IdGenerator idGenerator) {
this.delegates = delegates;
this.idGenerator = idGenerator;// 路由定义的id 生成器，默认UUID
}
@Override
public Flux&amp;lt;RouteDefinition&amp;gt; getRouteDefinitions() {
//遍历执行所有RouteDefinitionLocator的查找路由定义方法,将找到的路由定义合并
return this.delegates
.flatMapSequential(RouteDefinitionLocator::getRouteDefinitions)
.flatMap(routeDefinition -&amp;gt; {
if (routeDefinition.getId() == null) {
return randomId().map(id -&amp;gt; {
routeDefinition.setId(id);// 设置uuid
if (log.isDebugEnabled()) {
log.debug(
&amp;quot;Id set on route definition: &amp;quot; + routeDefinition);
}
return routeDefinition;
});
}
return Mono.just(routeDefinition);
});
}
...
}
&lt;/code>&lt;/pre>&lt;blockquote>
&lt;ul>
&lt;li>PropertiesRouteDefinitionLocator: 从配置文件(GatewayProperties 例如，YML / Properties 等 ) 读取RouteDefinition&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java"> &lt;span class="c1">//fzb 从GatewayProperties读取路由定义
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Flux&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">RouteDefinition&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">getRouteDefinitions&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Flux&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">fromIterable&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">properties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getRoutes&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;ul>
&lt;li>DiscoveryClientRouteDefinitionLocator 从注册中心如：Netflix Eureka， Consul 或 Zookeeper读取RouteDefinition&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="nf">DiscoveryClientRouteDefinitionLocator&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ReactiveDiscoveryClient&lt;/span> &lt;span class="n">discoveryClient&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">DiscoveryLocatorProperties&lt;/span> &lt;span class="n">properties&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">discoveryClient&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getClass&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getSimpleName&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">properties&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//fzb 通过服务发现客户端 ，比如eureka客户端从注册中心拿到所有的服务实例
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">serviceInstances&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">discoveryClient&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getServices&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">flatMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">service&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="n">discoveryClient&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getInstances&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">collectList&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>将服务实例serviceInstances转为路由定义&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Flux&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">RouteDefinition&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">getRouteDefinitions&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">SpelExpressionParser&lt;/span> &lt;span class="n">parser&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">SpelExpressionParser&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">Expression&lt;/span> &lt;span class="n">includeExpr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">parser&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">parseExpression&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">properties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getIncludeExpression&lt;/span>&lt;span class="o">());&lt;/span>&lt;span class="c1">//fzb 扩展点，可以通过properties 配置其他spel
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Expression&lt;/span> &lt;span class="n">urlExpr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">parser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">parseExpression&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">properties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getUrlExpression&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;ul>
&lt;li>RouteDefinitionRepository 从存储器(内存 / Redis / MySQL 等 )读取RouteDefinition，实现RouteDefinitionWriter接口；
提供删除和保存RouteDefinition的方法；
默认实现有：InMemoryRouteDefinitionRepository,没有RouteDefinitionRepository的实例，则默认用InMemoryRouteDefinitionRepository&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">InMemoryRouteDefinitionRepository&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">RouteDefinitionRepository&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">RouteDefinition&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">routes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">synchronizedMap&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="n">LinkedHashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">RouteDefinition&lt;/span>&lt;span class="o">&amp;gt;());&lt;/span>&lt;span class="c1">//fzb 内存中用 同步map 存储
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nd">@Override&lt;/span>&lt;span class="c1">// fzb 保存路由到内存中
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="n">Mono&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Void&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">save&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Mono&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">RouteDefinition&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">flatMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">r&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="o">()))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Mono&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">IllegalArgumentException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;id may not be empty&amp;#34;&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">routes&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="o">);&lt;/span>&lt;span class="c1">//保存
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">Mono&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">empty&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">});&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Override&lt;/span>&lt;span class="c1">// fzb 从内存中删除路由
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="n">Mono&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Void&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">delete&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Mono&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">routeId&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Override&lt;/span>&lt;span class="c1">// fzb 获取路由定义
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="n">Flux&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">RouteDefinition&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">getRouteDefinitions&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Flux&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">fromIterable&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">routes&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">values&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;ul>
&lt;li>自定义路由存储器,redis存储：RedisRouteDefinitionRepository
&lt;a href="https://github.com/fengzhenbing/spring-cloud-gateway-demo/blob/master/demo-gateway/src/main/java/org/fzb/demo/gateway/route/RedisRouteDefinitionRepository.java">https://github.com/fengzhenbing/spring-cloud-gateway-demo/blob/master/demo-gateway/src/main/java/org/fzb/demo/gateway/route/RedisRouteDefinitionRepository.java&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;h3 id="2路由">2.路由&lt;/h3>
&lt;ul>
&lt;li>路由Route&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Route&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">Ordered&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="c1">//fzb 路由地址
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">URI&lt;/span> &lt;span class="n">uri&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="c1">//fzb 路由的优先级
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">order&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">AsyncPredicate&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">ServerWebExchange&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">predicate&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="c1">//fzb gatewayFilter列表
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">GatewayFilter&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">gatewayFilters&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="c1">//fzb 元数据
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Object&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">metadata&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>路由定位器 RouteLocator
获取路由对象&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="nc">RouteLocator&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//fzb 获取路由对象
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Flux&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Route&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">getRoutes&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/routeLocator.png" alt="routeLocator" />&lt;/p>
&lt;p>类似RouteDefinitionLocator三个实现：&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>缓存：CachingRouteLocator： 缓存路由，查找时使用CompositeRouteLocator去查找&lt;/li>
&lt;li>组合： CompositeRouteLocator：使用多个RouteLocator查找路由并合并&lt;/li>
&lt;li>单个的 RouteDefinitionRouteLocator：最终使用RouteDefinitionLocator查找路由定义并转为路由对象Route
单个路由的 filters = GlobalFilter + 默认GatewayFilter + 本路由配置的GatewayFilter&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">RouteDefinitionRouteLocator&lt;/span>
&lt;span class="kd">implements&lt;/span> &lt;span class="n">RouteLocator&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">BeanFactoryAware&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ApplicationEventPublisherAware&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="nf">RouteDefinitionRouteLocator&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">RouteDefinitionLocator&lt;/span> &lt;span class="n">routeDefinitionLocator&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">RoutePredicateFactory&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">predicates&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">GatewayFilterFactory&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">gatewayFilterFactories&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">GatewayProperties&lt;/span> &lt;span class="n">gatewayProperties&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">ConfigurationService&lt;/span> &lt;span class="n">configurationService&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">routeDefinitionLocator&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">routeDefinitionLocator&lt;/span>&lt;span class="o">;&lt;/span>&lt;span class="c1">//fzb //设置路由定义定位器
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">configurationService&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">configurationService&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">initFactories&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">predicates&lt;/span>&lt;span class="o">);&lt;/span>&lt;span class="c1">//fzb //初始化路由断言工厂
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">gatewayFilterFactories&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">forEach&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="n">factory&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">gatewayFilterFactories&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">name&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">factory&lt;/span>&lt;span class="o">));&lt;/span>&lt;span class="c1">//fzb //初始化网关过滤器
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">gatewayProperties&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gatewayProperties&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="c1">//fzb 获取路由对象： 先获取RouteDefinition，再转为 Route
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Flux&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Route&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">getRoutes&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Flux&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Route&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">routes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">routeDefinitionLocator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getRouteDefinitions&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">map&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">convertToRoute&lt;/span>&lt;span class="o">);&lt;/span>&lt;span class="c1">//fzb RouteDefinition转为 Route
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//fzb 路由定义转为 路由
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="n">Route&lt;/span> &lt;span class="nf">convertToRoute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">RouteDefinition&lt;/span> &lt;span class="n">routeDefinition&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//fzb 1,将本路由定义中各个断言 与运算 合并为一个 AsyncPredicate
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">AsyncPredicate&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">ServerWebExchange&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">predicate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">combinePredicates&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">routeDefinition&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//fzb 2, 获取所有的默认的过滤器和本路由定义的过滤器
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">GatewayFilter&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">gatewayFilters&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getFilters&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">routeDefinition&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">// 组装Route
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">Route&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">async&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">routeDefinition&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">asyncPredicate&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">predicate&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">replaceFilters&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">gatewayFilters&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//fzb 过滤器定义filterDefinitions加载为过滤器GatewayFilter
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nd">@SuppressWarnings&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;unchecked&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">GatewayFilter&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">loadGatewayFilters&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">FilterDefinition&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">filterDefinitions&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">GatewayFilter&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">ordered&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;(&lt;/span>&lt;span class="n">filterDefinitions&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">filterDefinitions&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">FilterDefinition&lt;/span> &lt;span class="n">definition&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">filterDefinitions&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">GatewayFilterFactory&lt;/span> &lt;span class="n">factory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">gatewayFilterFactories&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">definition&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">factory&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">IllegalArgumentException&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="s">&amp;#34;Unable to find GatewayFilterFactory with name &amp;#34;&lt;/span>
&lt;span class="o">+&lt;/span> &lt;span class="n">definition&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">logger&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isDebugEnabled&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">logger&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;RouteDefinition &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; applying filter &amp;#34;&lt;/span>
&lt;span class="o">+&lt;/span> &lt;span class="n">definition&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getArgs&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; to &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">definition&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">// @formatter:off
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="n">configuration&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">configurationService&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">with&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">name&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">definition&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">())&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">properties&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">definition&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getArgs&lt;/span>&lt;span class="o">())&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">eventFunction&lt;/span>&lt;span class="o">((&lt;/span>&lt;span class="n">bound&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">properties&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">FilterArgsEvent&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="c1">// TODO: why explicit cast needed or java compile fails
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">RouteDefinitionRouteLocator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">this&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Object&lt;/span>&lt;span class="o">&amp;gt;)&lt;/span> &lt;span class="n">properties&lt;/span>&lt;span class="o">))&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">bind&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="c1">// @formatter:on
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// some filters require routeId
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// TODO: is there a better place to apply this?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">configuration&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="n">HasRouteId&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">HasRouteId&lt;/span> &lt;span class="n">hasRouteId&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">HasRouteId&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">configuration&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">hasRouteId&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setRouteId&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">GatewayFilter&lt;/span> &lt;span class="n">gatewayFilter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">factory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apply&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">configuration&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">gatewayFilter&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="n">Ordered&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ordered&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">gatewayFilter&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ordered&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">OrderedGatewayFilter&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">gatewayFilter&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">ordered&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">GatewayFilter&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">getFilters&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">RouteDefinition&lt;/span> &lt;span class="n">routeDefinition&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">GatewayFilter&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">filters&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;();&lt;/span>
&lt;span class="c1">//fzb 1,加上默认的过滤器
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// TODO: support option to apply defaults after route specific filters?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">gatewayProperties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getDefaultFilters&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">filters&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">addAll&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">loadGatewayFilters&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">DEFAULT_FILTERS&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">gatewayProperties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getDefaultFilters&lt;/span>&lt;span class="o">())));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//fzb 2,加上本路由配置的过滤器
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">routeDefinition&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getFilters&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">filters&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">addAll&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">loadGatewayFilters&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">routeDefinition&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="o">(),&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;(&lt;/span>&lt;span class="n">routeDefinition&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getFilters&lt;/span>&lt;span class="o">())));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//fzb 排序 按实现的Ordered接口
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">AnnotationAwareOrderComparator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sort&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">filters&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">filters&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//fzb combinePredicates主要是对找出来的predicate进行and操作
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="n">AsyncPredicate&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">ServerWebExchange&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">combinePredicates&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="n">RouteDefinition&lt;/span> &lt;span class="n">routeDefinition&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">PredicateDefinition&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">predicates&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">routeDefinition&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getPredicates&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">predicates&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">predicates&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// this is a very rare case, but possible, just match all
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">AsyncPredicate&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">from&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">exchange&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">AsyncPredicate&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">ServerWebExchange&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">predicate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lookup&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">routeDefinition&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">predicates&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">PredicateDefinition&lt;/span> &lt;span class="n">andPredicate&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">predicates&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">subList&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">predicates&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="o">()))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">AsyncPredicate&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">ServerWebExchange&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">found&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lookup&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">routeDefinition&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">andPredicate&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">predicate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">predicate&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">and&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">found&lt;/span>&lt;span class="o">);&lt;/span>&lt;span class="c1">//fzb and 各个断言 与 合并为一个 AsyncPredicate
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">predicate&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="类比">类比&lt;/h3>
&lt;ul>
&lt;li>Route -&amp;gt; RouteDefinition -&amp;gt;RouteDefinitionLocator -&amp;gt; xxxRouteDefinitionRepository&lt;/li>
&lt;li>Bean -&amp;gt; BeanDefinition -&amp;gt; BeanDefinitionRegistry -&amp;gt; DefaultListableBeanFactory#Map&amp;lt;String, BeanDefinition&amp;gt; beanDefinitionMap = new ConcurrentHashMap&amp;lt;&amp;gt;(256);&lt;/li>
&lt;/ul></description></item><item><title>06.route通过注册中心自动配置加载</title><link>https://fengzhenbing.github.io/p/06.route%E9%80%9A%E8%BF%87%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/</link><pubDate>Thu, 10 Dec 2020 08:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/06.route%E9%80%9A%E8%BF%87%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/</guid><description>&lt;h2 id="route通过注册中心eureka自动加载配置">route通过注册中心Eureka自动加载配置&lt;/h2>
&lt;h3 id="配置">配置&lt;/h3>
&lt;ul>
&lt;li>gateway及后端微服务引入注册中心客户端eureka-client&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="c">&amp;lt;!-- 引入 Spring Cloud Netflix Eureka Client 相关依赖，将 Eureka 作为注册中心的客户端，并实现对其的自动配置 --&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-starter-netflix-eureka-client&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>eureka-client starter的引入，会同时引入ribbon,作为后续请求，负载均衡的实现&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/eureka-ribbon.png" alt="eureka-ribbon" />&lt;/p>
&lt;p>spring.cloud.gateway.discovery.locator.enabled设为true,启用服务发现的DiscoveryClientRouteDefinitionLocator&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Spring Cloud Gateway 配置项，对应 GatewayProperties 类&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">gateway&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">discovery&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">locator&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">enabled&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># default fase，设为true开启&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Configuration&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">proxyBeanMethods&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@ConditionalOnProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;spring.cloud.discovery.reactive.enabled&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="c1">//fzb 默认使用响应式的方式
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">matchIfMissing&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ReactiveDiscoveryClientRouteDefinitionLocatorConfiguration&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Bean&lt;/span>&lt;span class="c1">//fzb spring.cloud.gateway.discovery.locator.enabled配为true时，才开启DiscoveryClientRouteDefinitionLocator
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nd">@ConditionalOnProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;spring.cloud.gateway.discovery.locator.enabled&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">DiscoveryClientRouteDefinitionLocator&lt;/span> &lt;span class="nf">discoveryClientRouteDefinitionLocator&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="n">ReactiveDiscoveryClient&lt;/span> &lt;span class="n">discoveryClient&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="c1">//响应式的客服端 Eureka就是 EurekaReactiveDiscoveryClient
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DiscoveryLocatorProperties&lt;/span> &lt;span class="n">properties&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">DiscoveryClientRouteDefinitionLocator&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">discoveryClient&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">properties&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>eureka-client的引入，会开启TimedSupervisorTask执行HeartbeatThread的心跳任务， 默认每隔30s一次&lt;/li>
&lt;/ul>
&lt;p>RouteRefreshListener 每隔30s接收到HeartBeatEvent事件，同时会发送RefreshRoutes事件&lt;/p>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/rrf.png" alt="rrf" />&lt;/p>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/heartbeat.png" alt="heartbeat" />&lt;/p>
&lt;p>CachingRouteLocator 收到RefreshRoutesEvent事件，重新获取路由时会发现多了一个DiscoveryClientRouteDefinitionLocator （负责从注册中心获取新路由配置）&lt;/p>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/cacheroutelocator.png" alt="cacheroutelocator" />&lt;/p>
&lt;h3 id="验证">验证&lt;/h3>
&lt;p>http://localhost:7070/ORDER/order/get 前边ORDER为eureka-client从eureka-server获取的服务名，&lt;/p>
&lt;p>LoadBalancerClientFilter在NettyRoutingFilter之前通过ribbon执行负载均衡策略，选择一个服务实例&lt;/p>
&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/lbancerClient.png" alt="lbancerClient" />&lt;/p>
&lt;h3 id="总结">总结&lt;/h3>
&lt;ul>
&lt;li>springgateway 接收注册中心心跳事件，发送路由刷新事件，&lt;/li>
&lt;li>CachingRouteLocator 最终调用DiscoveryClientRouteDefinitionLocator#getRouteDefinitions 获取注册中心最新的路由&lt;/li>
&lt;/ul>
&lt;p>代码实现:https://github.com/fengzhenbing/spring-cloud-gateway-demo.git&lt;/p></description></item><item><title>07.precidate的对路由进行选择</title><link>https://fengzhenbing.github.io/p/07.precidate%E7%9A%84%E5%AF%B9%E8%B7%AF%E7%94%B1%E8%BF%9B%E8%A1%8C%E9%80%89%E6%8B%A9/</link><pubDate>Thu, 10 Dec 2020 08:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/07.precidate%E7%9A%84%E5%AF%B9%E8%B7%AF%E7%94%B1%E8%BF%9B%E8%A1%8C%E9%80%89%E6%8B%A9/</guid><description>&lt;h1 id="precidate选择路由">precidate选择路由&lt;/h1></description></item><item><title>08.filter的配置加载及合并</title><link>https://fengzhenbing.github.io/p/08.filter%E7%9A%84%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD%E5%8F%8A%E5%90%88%E5%B9%B6/</link><pubDate>Thu, 10 Dec 2020 08:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/08.filter%E7%9A%84%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD%E5%8F%8A%E5%90%88%E5%B9%B6/</guid><description/></item><item><title>soul整体结构</title><link>https://fengzhenbing.github.io/p/soul%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84/</link><pubDate>Thu, 10 Dec 2020 08:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/soul%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84/</guid><description>&lt;h3 id="soul介绍">soul介绍&lt;/h3>
&lt;p>&lt;a class="link" href="https://dromara.org/zh/" target="_blank" rel="noopener"
>官网&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://dromara.org/img/architecture/soul-framework.png" alt="img" />&lt;/p>
&lt;ul>
&lt;li>高性能，多协议，易扩展，响应式的API Gateway&lt;/li>
&lt;/ul>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>丰富的协议&lt;/th>
&lt;th>支持 dubbo ，tars， springcloud grpc。&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>插件化&lt;/td>
&lt;td>插件化设计思想，插件热插拔，易扩展。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>流控&lt;/td>
&lt;td>灵活的流量筛选，能满足各种流量控制。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>内置插件&lt;/td>
&lt;td>内置丰富的插件支持，鉴权，限流，熔断，防火墙等。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>高性能&lt;/td>
&lt;td>流量配置动态化，性能极高，网关消耗在 1~2ms。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>集群部署&lt;/td>
&lt;td>支持集群部署，支持 A/B Test，蓝绿发布。&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="soul项目结构">soul项目结构&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>soul-admin&lt;/p>
&lt;p>soul网关管理端，配合soul-dashbord&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Soul-bootstrap&lt;/p>
&lt;p>网关启动工程： 实际引入soul-spring-boot-starter-gateway(soul-web)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Soul-client&lt;/p>
&lt;p>为下游服务提供者提供各类服务接入网关soul的客户端&lt;/p>
&lt;ul>
&lt;li>Soul-client-common&lt;/li>
&lt;li>Soul-client-dubbo&lt;/li>
&lt;li>Soul-client-grpc&lt;/li>
&lt;li>Soul-client-http&lt;/li>
&lt;li>Soul-client-sofa&lt;/li>
&lt;li>Soul-client-tars&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Soul-common&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Soul-dashbord&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Soul-dist&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Soul-example&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Soul-metrics&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Soul-plugin&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Soul-register-center&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Soul-spi&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Soul-spring-boot-starter&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Soul-sync-data-center&lt;/p>
&lt;ul>
&lt;li>Soul-sync-data-api&lt;/li>
&lt;li>Soul-sync-data-http&lt;/li>
&lt;li>Soul-sync-data-nacos&lt;/li>
&lt;li>Soul-sync-data-websocket&lt;/li>
&lt;li>Soul-sync-data-zookeeper&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Soul-web&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>安装redis</title><link>https://fengzhenbing.github.io/p/%E5%AE%89%E8%A3%85redis/</link><pubDate>Thu, 10 Dec 2020 08:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/%E5%AE%89%E8%A3%85redis/</guid><description>&lt;h2 id="下载">下载&lt;/h2>
&lt;p>&lt;a href="https://redis.io/download">https://redis.io/download&lt;/a>&lt;/p>
&lt;h2 id="编译">编译&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">wget https://download.redis.io/releases/redis-6.0.10.tar.gz
tar xzf redis-6.0.10.tar.gz
&lt;span class="nb">cd&lt;/span> redis-6.0.10
sudo make
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="运行">运行&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#复制配置文件及命令&lt;/span>
mkdir ./bin
mkdir ./conf
sudo cp ./src/mkreleasehdr.sh ./bin
sudo cp ./src/redis-benchmark ./bin
sudo cp ./src/redis-check-rdb ./bin
sudo cp ./src/redis-cli ./bin
sudo cp ./src/redis-server ./bin
sudo cp ./redis.conf ./conf
&lt;span class="c1">#运行&lt;/span>
./bin/redis-server ./conf/redis.conf
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="配置">配置&lt;/h2>
&lt;p>redis.conf&lt;/p>
&lt;pre>&lt;code>#修改为守护模式
daemonize yes
#设置进程锁文件
pidfile /usr/local/redis-4.0.11/redis.pid
#端口
port 6379
#客户端超时时间
timeout 300
#日志级别
loglevel debug
#日志文件位置
logfile /usr/local/redis-4.0.11/log-redis.log
#设置数据库的数量，默认数据库为0，可以使用SELECT &amp;lt;dbid&amp;gt;命令在连接上指定数据库id
databases 16
##指定在多长时间内，有多少次更新操作，就将数据同步到数据文件，可以多个条件配合
#save &amp;lt;seconds&amp;gt; &amp;lt;changes&amp;gt;
#Redis默认配置文件中提供了三个条件：
save 900 1
save 300 10
save 60 10000
#指定存储至本地数据库时是否压缩数据，默认为yes，Redis采用LZF压缩，如果为了节省CPU时间，
#可以关闭该#选项，但会导致数据库文件变的巨大
rdbcompression yes
#指定本地数据库文件名
dbfilename dump.rdb
#指定本地数据库路径
dir /usr/local/redis-4.0.11/db/
#指定是否在每次更新操作后进行日志记录，Redis在默认情况下是异步的把数据写入磁盘，如果不开启，可能
#会在断电时导致一段时间内的数据丢失。因为 redis本身同步数据文件是按上面save条件来同步的，所以有
#的数据会在一段时间内只存在于内存中
appendonly no
#指定更新日志条件，共有3个可选值：
#no：表示等操作系统进行数据缓存同步到磁盘（快）
#always：表示每次更新操作后手动调用fsync()将数据写到磁盘（慢，安全）
#everysec：表示每秒同步一次（折衷，默认值）
appendfsync everysec
&lt;/code>&lt;/pre>&lt;h2 id="docker">Docker&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#最新镜像&lt;/span>
docker pull redis
&lt;span class="c1">#运行&lt;/span>
docker run -itd --name redis-test -p 6379:6379 redis docker image inspect redis:latest&lt;span class="p">|&lt;/span>grep -i version
&lt;span class="c1">#运行&lt;/span>
docker &lt;span class="nb">exec&lt;/span> -it redis-test /bin/bash
$ redis-cli
&amp;gt; info
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>
&lt;p>指定配置文件运行&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker run -p 6379:6379 --name redis-test -v /etc/redis/redis.conf:/etc/redis/redis.conf -v /etc/redis/data:/data -d redis redis-server /etc/redis/redis.conf --appendonly yes
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>停止&lt;/p>
&lt;pre>&lt;code>docker stop redis-test
&lt;/code>&lt;/pre>&lt;/li>
&lt;/ul></description></item><item><title>Hugo搭建博客</title><link>https://fengzhenbing.github.io/p/hugo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/</link><pubDate>Tue, 08 Dec 2020 08:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/hugo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/</guid><description>&lt;p>通过Hugo搭建静态博客网站，再通过github pages部署运行&lt;/p>
&lt;h3 id="hugo介绍">Hugo介绍&lt;/h3>
&lt;ul>
&lt;li>Hugo是一种用Go语言编写的快速，现代的静态网站生成器，旨在让网站创建再次变得有趣。&lt;/li>
&lt;li>性能高，安全性和易用性是主要特点&lt;/li>
&lt;li>拥有超快的速度，强大的内容管理和强大的模板语言，使其非常适合各种静态网站。&lt;/li>
&lt;/ul>
&lt;h3 id="hugo安装">Hugo安装&lt;/h3>
&lt;pre>&lt;code># mac上安装
brew install hugo
# windows可通过Chocolatey上安装
choco install hugo -confirm
# 版本验证
hugo version
&lt;/code>&lt;/pre>&lt;h3 id="hugo主题">hugo主题&lt;/h3>
&lt;ul>
&lt;li>&lt;a class="link" href="https://themes.gohugo.io/" target="_blank" rel="noopener"
>查找你喜欢的主题&lt;/a>&lt;/li>
&lt;li>在此我选择的主题为toha &lt;a class="link" href="https://toha-guides.netlify.app/posts/getting-started/" target="_blank" rel="noopener"
>详情&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="初始化网站模板">初始化网站模板&lt;/h3>
&lt;pre>&lt;code># 首先在github下创建xxx.github.io的仓库
git clone https://github.com/fengzhenbing/fengzhenbing.github.io.git
cd ./fengzhenbing.github.io
# 初始化模板
hugo new site ./ -f=yaml --force
#添加hugo-toha主题
git submodule add https://github.com/hugo-toha/toha.git themes/toha
#本地运行
hugo server -t toha -w
&lt;/code>&lt;/pre>&lt;h3 id="修改配置">修改配置&lt;/h3>
&lt;p>参考themes/toha/exampleSite，配置网站根目录下的config.yml文件，配置网站各个模块&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">baseURL&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://fengzhenbing.github.io/&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">languageCode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">en-us&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">defaultContentLanguage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cn&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">title&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Feng Zhenbing&amp;#39;s Blog&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">theme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;toha&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Manage languages&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># For any more details, you can check the official documentation: https://gohugo.io/content-management/multilingual/&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">languages&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">cn&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">languageName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">中文&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">weight&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># en:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># languageName: English&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># weight: 2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Control TOC depth&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">markup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">tableOfContents&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">startLevel&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">endLevel&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">6&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ordered&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Enable global emoji support&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">enableEmoji&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Site parameters&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># GitHub repo URL of your site&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">gitRepo&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://github.com/fengzhenbing/fengzhenbing.github.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">gitBranch&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">master&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># specify whether you want to write some blog posts or not&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">enableBlogPost&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># specify whether you want to show Table of Contents in reading page&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">enableTOC&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Provide newsletter configuration. This feature hasn&amp;#39;t been implemented yet.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Currently, you can just hide it from the footer.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">newsletter&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">enable&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>至此浏览器中查看&lt;a class="link" href="http://localhost:1313/" target="_blank" rel="noopener"
>http://localhost:1313/&lt;/a> 可看到大致的博客网站,&lt;/li>
&lt;li>更多细节查看&lt;a class="link" href="https://toha-guides.netlify.app/posts/getting-started/prepare-site/" target="_blank" rel="noopener"
>https://toha-guides.netlify.app/posts/getting-started/prepare-site/&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="github-pages-中部署">Github Pages 中部署&lt;/h3>
&lt;ul>
&lt;li>创建分支&lt;/li>
&lt;/ul>
&lt;pre>&lt;code>#github 创建部署文件的分支
git branch -b gh-pages
git push
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>
&lt;p>github中setting中将部署分支设为gh-pages分支
&lt;figure style="flex-grow: 138; flex-basis: 331px">
&lt;a href="https://fengzhenbing.github.io/p/hugo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/img.png" data-size="1211x876">&lt;img src="https://fengzhenbing.github.io/p/hugo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/img.png"
srcset="https://fengzhenbing.github.io/p/hugo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/img_hufde637fbf01d56811fb1bb56bcbb807d_81033_480x0_resize_box_2.png 480w, https://fengzhenbing.github.io/p/hugo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/img_hufde637fbf01d56811fb1bb56bcbb807d_81033_1024x0_resize_box_2.png 1024w"
width="1211"
height="876"
loading="lazy"
alt="img.png">
&lt;/a>
&lt;figcaption>img.png&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>开启github actions
&lt;figure style="flex-grow: 166; flex-basis: 399px">
&lt;a href="https://fengzhenbing.github.io/p/hugo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/img_1.png" data-size="1008x605">&lt;img src="https://fengzhenbing.github.io/p/hugo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/img_1.png"
srcset="https://fengzhenbing.github.io/p/hugo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/img_1_hu0fd027d176be4424c185f73e72a53646_66920_480x0_resize_box_2.png 480w, https://fengzhenbing.github.io/p/hugo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/img_1_hu0fd027d176be4424c185f73e72a53646_66920_1024x0_resize_box_2.png 1024w"
width="1008"
height="605"
loading="lazy"
alt="img_1.png">
&lt;/a>
&lt;figcaption>img_1.png&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>编写github actions的部署文件&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="c"># 进入网站根目录，创建./github/workflows目录&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="l">mkdir ./github/workflows&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="l">cd ./github/workflows&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="l">vim deploy-site.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>deploy-site.yaml&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deploy to Github Pages&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># run when a commit or pr is pushed to &amp;#34;master&amp;#34; branch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">pull_request&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">push&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">branches&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">master&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">jobs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">runs-on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ubuntu-18.04&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># checkout to the commit that has been pushed&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">actions/checkout@v2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">with&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">submodules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Fetch Hugo themes (true OR recursive)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">fetch-depth&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Fetch all history for .GitInfo and .Lastmod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># install Hugo&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Setup Hugo&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">peaceiris/actions-hugo@v2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">with&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">hugo-version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0.77.0&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">extended&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># build website&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Build&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">hugo --minify&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># push the generated content into the `main` (former `master`) branch.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deploy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">peaceiris/actions-gh-pages@v3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">if&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">github.event_name == &amp;#39;push&amp;#39; &amp;amp;&amp;amp; github.ref == &amp;#39;refs/heads/master&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">with&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">github_token&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${{ secrets.GITHUB_TOKEN }}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_branch&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gh-pages&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># if your main branch is `master` use that here.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_dir&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">./public&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>提交后，每次改动master分支，github action会运行以上任务，自动打包文件到gh-pages分支，并部署&lt;/p></description></item><item><title>配置中心刷新</title><link>https://fengzhenbing.github.io/p/%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%88%B7%E6%96%B0/</link><pubDate>Tue, 08 Dec 2020 00:00:00 +0000</pubDate><guid>https://fengzhenbing.github.io/p/%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%88%B7%E6%96%B0/</guid><description>&lt;h2 id="配置中心刷新原理">配置中心刷新原理&lt;/h2>
&lt;p>nacos和spring cloud config两种配置中心动态刷新的范围都是以下两种：&lt;/p>
&lt;ul>
&lt;li>@ConfigurationProperties 注解的配置类&lt;/li>
&lt;li>@RefreshScope 注解的bean&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://img-blog.csdnimg.cn/20190308142218999.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dvc2hpbGlqaXV5aQ==,size_16,color_FFFFFF,t_70" alt="img" />&lt;/p>
&lt;h2 id="手动刷新">手动刷新&lt;/h2>
&lt;p>post请求config客户端的/refresh端点&lt;/p>
&lt;h2 id="自动刷新">自动刷新&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>WebHooks动态触发刷新&lt;/p>
&lt;/li>
&lt;li>
&lt;p>spring-cloud-bus动态刷新&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://springcloud-oss.oss-cn-shanghai.aliyuncs.com/chapter8/configbus2.jpg" alt="img" />&lt;/p>
&lt;p>这时Spring Cloud Bus做配置更新步骤如下:&lt;/p>
&lt;ol>
&lt;li>提交代码触发post给Server端发送bus/refresh&lt;/li>
&lt;li>Server端接收到请求并发送给Spring Cloud Bus&lt;/li>
&lt;li>Spring Cloud bus接到消息并通知给其它客户端&lt;/li>
&lt;li>其它客户端接收到通知，请求Server端获取最新配置&lt;/li>
&lt;li>全部客户端均获取到最新的配置&lt;/li>
&lt;/ol>
&lt;p>这样的话我们在server端的代码做一些改动，来支持/actuator/bus-refresh&lt;/p>
&lt;h2 id="spring-cloud-bus">Spring Cloud Bus&lt;/h2>
&lt;p>Spring Cloud Bus 使用轻量级的消息代理来连接微服务架构中的各个服务，可以将其用于广播状态更改（例如配置中心配置更改）或其他管理指令&lt;/p>
&lt;p>目前 Spring Cloud Bus 支持两种消息代理：RabbitMQ 和 Kafka。&lt;/p>
&lt;p>参考&lt;/p>
&lt;p>&lt;a href="https://blog.csdn.net/woshilijiuyi/article/details/88293782">https://blog.csdn.net/woshilijiuyi/article/details/88293782&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://www.cnblogs.com/babycomeon/p/11141160.html">https://www.cnblogs.com/babycomeon/p/11141160.html&lt;/a>&lt;/p></description></item><item><title>小程序框架</title><link>https://fengzhenbing.github.io/p/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%A1%86%E6%9E%B6/</link><pubDate>Mon, 23 Nov 2020 00:00:00 +0000</pubDate><guid>https://fengzhenbing.github.io/p/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%A1%86%E6%9E%B6/</guid><description>&lt;h2 id="小程序原理">小程序原理&lt;/h2>
&lt;p>&lt;img src="https://fengzhenbing.github.io/images/blog/image-20210313143033016.png" alt="image-20210313143033016" />&lt;/p>
&lt;ul>
&lt;li>使用两个线程：保证平台安全性，不能让开发者控制 render 线程，控制 render 线程将会造成小程序平台方管控困难&lt;/li>
&lt;li>worker线程： 用户控制
&lt;ul>
&lt;li>响应 render 线程的事件，并执行小程序业务逻辑。&lt;/li>
&lt;li>准备好数据，通过 setData 传到 page 中，由 page 进行渲染。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>render线程：接收数据渲染到页面&lt;/li>
&lt;/ul>
&lt;h2 id="taro">TARO&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;a class="link" href="https://taro-docs.jd.com/taro/docs/GETTING-STARTED" target="_blank" rel="noopener"
>官网&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://taro-ui.jd.com/">https://taro-ui.jd.com/&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>特点&lt;/p>
&lt;ul>
&lt;li>
&lt;p>编译时转换&lt;/p>
&lt;/li>
&lt;li>
&lt;p>React vue &amp;hellip;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>一套组件可以在 &lt;code>微信小程序&lt;/code>，&lt;code>支付宝小程序&lt;/code>，&lt;code>百度小程序&lt;/code>，&lt;code>H5&lt;/code> 多端适配运行&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>创建项目&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># 使用 npm 安装 CLI&lt;/span>
$ npm install -g @tarojs/cli
&lt;span class="c1"># OR 使用 yarn 安装 CLI&lt;/span>
$ yarn global add @tarojs/cli
&lt;span class="c1"># OR 安装了 cnpm，使用 cnpm 安装 CLI&lt;/span>
$ cnpm install -g @tarojs/cli
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h2 id="remax">Remax&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;a class="link" href="https://remaxjs.org/" target="_blank" rel="noopener"
>官网&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>特点&lt;/p>
&lt;ul>
&lt;li>
&lt;p>运行时转换:worker 线程维护一棵 vdom tree，然后同步到 render 线程通过 w|axml 来进行渲染。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>react开发&lt;/p>
&lt;/li>
&lt;li>
&lt;p>多平台支持：支持阿里程序、微信小程序(QQ小程序)、头条小程序以及 Web 应用的开发。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>创建项目&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">npx create-remax-app my-app
&lt;span class="nb">cd&lt;/span> my-app &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> npm install
npm run dev &amp;lt;platform&amp;gt; &lt;span class="c1"># 跨平台，如：要在阿里小程序环境运行，则 npm run dev ali&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>案例&lt;a class="link" href="https://github.com/remaxjs/awesome-remax" target="_blank" rel="noopener"
>https://github.com/remaxjs/awesome-remax&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="webpy">WebPY&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;a class="link" href="https://wepyjs.gitee.io/" target="_blank" rel="noopener"
>官网&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>特点&lt;/p>
&lt;ul>
&lt;li>类似Vue开发&lt;/li>
&lt;li>腾讯出品：小程序最早的框架之一&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>创建项目&lt;/p>
&lt;pre>&lt;code>$ npm install @wepy/cli -g # 全局安装 WePY CLI 工具
$ wepy init standard myproj # 使用 standard 模板初始化项目
$ cd myproj # 进入到项目目录
$ npm install # 安装项目依赖包
$ npm run dev # 监听并且编译项目
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>案例&lt;a class="link" href="https://github.com/aben1188/awesome-wepy" target="_blank" rel="noopener"
>https://github.com/aben1188/awesome-wepy&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="kbone">Kbone&lt;/h2>
&lt;ul>
&lt;li>特点
&lt;ul>
&lt;li>运行时转换:worker 线程维护一棵 vdom tree，然后同步到 render 线程通过 w|axml 来进行渲染。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="uniapp">uniapp&lt;/h2>
&lt;p>参考：&lt;a class="link" href="https://developers.weixin.qq.com/community/develop/article/doc/000200eb844228d72f79291a651c13" target="_blank" rel="noopener"
>小程序多平台同构方案分析-kbone 与 remax&lt;/a>&lt;/p></description></item><item><title>kafka基础</title><link>https://fengzhenbing.github.io/p/kafka%E5%9F%BA%E7%A1%80/</link><pubDate>Tue, 20 Oct 2020 14:06:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/kafka%E5%9F%BA%E7%A1%80/</guid><description>&lt;h2 id="kafka相关概念">kafka相关概念&lt;/h2>
&lt;p>二代mq, scala开发&lt;/p>
&lt;ul>
&lt;li>broker&lt;/li>
&lt;li>topic&lt;/li>
&lt;li>patition&lt;/li>
&lt;li>producer&lt;/li>
&lt;li>customer&lt;/li>
&lt;li>Customer group&lt;/li>
&lt;li>leader&lt;/li>
&lt;li>follower&lt;/li>
&lt;li>rebalance
&lt;ul>
&lt;li>服务端partition数量扩大&lt;/li>
&lt;li>消费者组中某个消费者down掉&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="topic特性">Topic特性&lt;/h2>
&lt;ol>
&lt;li>通过partition增加可扩展性：线上改partion数，rebalance ，会照成性能抖动。&lt;/li>
&lt;li>partition有序达到高吞吐&lt;/li>
&lt;li>partition多副本增加容错性&lt;/li>
&lt;/ol>
&lt;h2 id="kafka单机">kafka单机&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>安装 &lt;a href="http://kafka.apache.org/downloads">http://kafka.apache.org/downloads&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>修改配置&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nb">cd&lt;/span> kafka_2.13-2.7.0
&lt;span class="c1"># 打开 listeners=PLAINTEXT://localhost:9092&lt;/span>
vim config/server.properties
&lt;span class="c1"># 启动zookeeper&lt;/span>
bin/zookeeper-server-start.sh config/zookeeper.properties
&lt;span class="c1"># 启动kafaka&lt;/span>
bin/kafka-server-start.sh config/server.properties
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>命令测试&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># 创建topic&lt;/span>
mokernetdeMac-mini:kafka_2.13-2.7.0 mokernet$ bin/kafka-topics.sh --zookeeper localhost:2181 --create --topic testf --partitions &lt;span class="m">4&lt;/span> --replication-factor &lt;span class="m">1&lt;/span>
Created topic testf.
&lt;span class="c1"># 查看&lt;/span>
bin/kafka-topics.sh --zookeeper localhost:2181 --describe --topic testf
&lt;span class="c1"># 消费者从头开始消费&lt;/span>
bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --from-beginning --topic testf
&lt;span class="c1"># 生产者生产&lt;/span>
bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic testf
&lt;span class="c1"># 生产者性能测试 100万条数据 每条1000byte 限流100万条&lt;/span>
bin/kafka-producer-perf-test.sh --topic testf --num-records &lt;span class="m">1000000&lt;/span> --record-size &lt;span class="m">1000&lt;/span> --throughput &lt;span class="m">1000000&lt;/span> --producer-props bootstrap.servers&lt;span class="o">=&lt;/span>localhost:9092
&lt;span class="c1"># 消费者性能测试 消费100万条数据 一个线程&lt;/span>
bin/kafka-consumer-perf-test.sh --bootstrap-server localhost:9092 --topic testf --fetch-size &lt;span class="m">1048576&lt;/span> --messages &lt;span class="m">1000000&lt;/span> --threads &lt;span class="m">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="kafka集群">kafka集群&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>修改各个节点的三个属性配置如下：&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># 复制新的配置文件&lt;/span>
cp config/server.properties config/server-1.properties
cp config/server.properties config/server-2.properties
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code class="language-properties" data-lang="properties"># 修改 id 端口 数据文件目录
# config/server-1.properties:
broker.id=1
listeners=PLAINTEXT://:9093
log.dir=/tmp/kafka-logs-1
&lt;/code>&lt;/pre>&lt;pre>&lt;code class="language-properties" data-lang="properties"># 修改 id 端口 数据文件目录
# config/server-2.properties:
broker.id=2
listeners=PLAINTEXT://:9094
log.dir=/tmp/kafka-logs-2
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>启动&lt;/p>
&lt;pre>&lt;code>bin/kafka-server-start.sh config/server.properties &amp;amp;
bin/kafka-server-start.sh config/server-1.properties &amp;amp;
bin/kafka-server-start.sh config/server-2.properties &amp;amp;
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>测试&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># 创建topic test42 4个patition 2个副本&lt;/span>
bin/kafka-topics.sh --zookeeper localhost:2181 --create --topic test42 --partitions &lt;span class="m">4&lt;/span> --replication-factor &lt;span class="m">2&lt;/span>
&lt;span class="c1"># 查看&lt;/span>
mokernetdeMac-mini:kafka_2.13-2.7.0 mokernet$ bin/kafka-topics.sh --zookeeper localhost:2181 --describe --topic test42
Topic: test42 PartitionCount: &lt;span class="m">4&lt;/span> ReplicationFactor: &lt;span class="m">2&lt;/span> Configs:
Topic: test42 Partition: &lt;span class="m">0&lt;/span> Leader: &lt;span class="m">1&lt;/span> Replicas: 1,2 Isr: 1,2
Topic: test42 Partition: &lt;span class="m">1&lt;/span> Leader: &lt;span class="m">2&lt;/span> Replicas: 2,0 Isr: 2,0
Topic: test42 Partition: &lt;span class="m">2&lt;/span> Leader: &lt;span class="m">0&lt;/span> Replicas: 0,1 Isr: 0,1
Topic: test42 Partition: &lt;span class="m">3&lt;/span> Leader: &lt;span class="m">1&lt;/span> Replicas: 1,0 Isr: 1,0
&lt;span class="c1"># 消费者从头开始消费&lt;/span>
bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --from-beginning --topic test42
&lt;span class="c1"># 生产者生产&lt;/span>
bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic test42
&lt;span class="c1"># 容错性测试 ，关闭id=1的broker&lt;/span>
ps aux &lt;span class="p">|&lt;/span> grep server-1.properties
&amp;gt; mokernet &lt;span class="m">30302&lt;/span> 0.0 1.9 &lt;span class="m">7323756&lt;/span> &lt;span class="m">405020&lt;/span> s006 S+ 10:31PM 0:16.87 /usr/bin/java -Xmx
&lt;span class="nb">kill&lt;/span> -9 &lt;span class="m">30302&lt;/span>
&lt;span class="c1">#查看 如下，rebalance&lt;/span>
mokernetdeMac-mini:kafka_2.13-2.7.0 mokernet$ bin/kafka-topics.sh --zookeeper localhost:2181 --describe --topic test42
Topic: test42 PartitionCount: &lt;span class="m">4&lt;/span> ReplicationFactor: &lt;span class="m">2&lt;/span> Configs:
Topic: test42 Partition: &lt;span class="m">0&lt;/span> Leader: &lt;span class="m">2&lt;/span> Replicas: 1,2 Isr: &lt;span class="m">2&lt;/span>
Topic: test42 Partition: &lt;span class="m">1&lt;/span> Leader: &lt;span class="m">2&lt;/span> Replicas: 2,0 Isr: 2,0
Topic: test42 Partition: &lt;span class="m">2&lt;/span> Leader: &lt;span class="m">0&lt;/span> Replicas: 0,1 Isr: &lt;span class="m">0&lt;/span>
Topic: test42 Partition: &lt;span class="m">3&lt;/span> Leader: &lt;span class="m">0&lt;/span> Replicas: 1,0 Isr: &lt;span class="m">0&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="kafka-connect">Kafka connect&lt;/h2>
&lt;ul>
&lt;li>通过kafka导入导出数据&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># 写入数据到输入文件 test.txt&lt;/span>
&lt;span class="nb">echo&lt;/span> -e &lt;span class="s2">&amp;#34;testtest&amp;#34;&lt;/span> &amp;gt; test.txt
&lt;span class="c1"># 启动connect&lt;/span>
&lt;span class="c1"># 三个配置文件： &lt;/span>
&lt;span class="c1"># 1. Kafka Connect的配置文件，包含常用的配置，如Kafka brokers连接方式和数据的序列化格式。&lt;/span>
&lt;span class="c1"># 2. 源连接器配置，用于从输入文件读取行，并将其输入到 Kafka topic&lt;/span>
&lt;span class="c1"># 3. 接收器连接器配置，它从Kafka topic中读取消息，并在输出文件中生成一行。&lt;/span>
bin/connect-standalone.sh config/connect-standalone.properties config/connect-file-source.properties config/connect-file-sink.properties
&lt;span class="c1"># 查看输出文件， 可以看到不断地往 test.txt写入数据时，test.sink.txt 会持续产生数据&lt;/span>
tail -f test.sink.txt
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="kafak-stream">kafak stream&lt;/h2>
&lt;ul>
&lt;li>
&lt;ul>
&lt;li>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="kafka-特点">Kafka 特点&lt;/h2>
&lt;ul>
&lt;li>高吞吐量、低延迟：kafka每秒可以处理几十万条消息，它的延迟最低只有几毫秒；&lt;/li>
&lt;li>可扩展性：kafka集群支持热扩展；&lt;/li>
&lt;li>持久性、可靠性：消息被持久化到本地磁盘，并且支持数据备份防止丢失；&lt;/li>
&lt;li>容错性：允许集群中的节点失败(若分区副本数量为n,则允许n-1个节点失败)；&lt;/li>
&lt;li>高并发：单机可支持数千个客户端同时读写；&lt;/li>
&lt;/ul>
&lt;h2 id="使用场景">使用场景&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>消息系统&lt;/p>
&lt;/li>
&lt;li>
&lt;p>日志聚合&lt;/p>
&lt;/li>
&lt;li>
&lt;p>度量监控&lt;/p>
&lt;/li>
&lt;li>
&lt;p>流式处理&lt;/p>
&lt;/li>
&lt;li>
&lt;p>跟踪网站浏览记录&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="相关资料">相关资料&lt;/h2>
&lt;p>参考 &lt;a href="https://kafka.apachecn.org/">https://kafka.apachecn.org/&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://mp.weixin.qq.com/s?__biz=MzU1NDA0MDQ3MA==&amp;amp;mid=2247483958&amp;amp;idx=1&amp;amp;sn=dffaad318b50f875eea615bc3bdcc80c&amp;amp;chksm=fbe8efcfcc9f66d9ff096fbae1c2a3671f60ca4dc3e7412ebb511252e7193a46dcd4eb11aadc&amp;amp;scene=21#wechat_redirect" target="_blank" rel="noopener"
>大白话 kafka 架构原理&lt;/a>&lt;/p></description></item><item><title>消息基础</title><link>https://fengzhenbing.github.io/p/%E6%B6%88%E6%81%AF%E5%9F%BA%E7%A1%80/</link><pubDate>Sun, 11 Oct 2020 09:16:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/%E6%B6%88%E6%81%AF%E5%9F%BA%E7%A1%80/</guid><description>&lt;h2 id="消息队列作用">消息队列作用&lt;/h2>
&lt;ol>
&lt;li>异步通信：异步通信，减少线程等待，特别是处理批量等大事务、耗时操作。&lt;/li>
&lt;li>系统解耦:系统不直接调用，降低依赖，特别是不在线也能保持通信最终完成。&lt;/li>
&lt;li>削峰填谷:压力大的时候，缓冲部分请求消息，类似于背压处理。&lt;/li>
&lt;li>可靠通信:提供多种消息模式、服务质量、顺序保障等。&lt;/li>
&lt;/ol>
&lt;h2 id="消息处理模式">消息处理模式&lt;/h2>
&lt;ol>
&lt;li>点对点： PTP =&amp;gt; queue&lt;/li>
&lt;li>发布订阅： PubSub =&amp;gt; Topic&lt;/li>
&lt;/ol>
&lt;h2 id="消息语义-qos">消息语义 QOS&lt;/h2>
&lt;ol>
&lt;li>At most once&lt;/li>
&lt;li>At least once&lt;/li>
&lt;li>Exactly once&lt;/li>
&lt;/ol></description></item><item><title>全局事物</title><link>https://fengzhenbing.github.io/p/%E5%85%A8%E5%B1%80%E4%BA%8B%E7%89%A9/</link><pubDate>Thu, 13 Aug 2020 14:16:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/%E5%85%A8%E5%B1%80%E4%BA%8B%E7%89%A9/</guid><description>&lt;p>&lt;img src="https://gitee.com/fengzhenbing/picgo/raw/master/20200526140940829.png" alt="20200526140940829" />&lt;/p>
&lt;h2 id="两段式提交">两段式提交&lt;/h2>
&lt;p>（2 Phase Commit，2PC）&lt;/p>
&lt;h3 id="准备阶段">&lt;strong>准备阶段&lt;/strong>&lt;/h3>
&lt;p>重操作&lt;/p>
&lt;h3 id="提交阶段">&lt;strong>提交阶段&lt;/strong>&lt;/h3>
&lt;p>轻操作&lt;/p>
&lt;h2 id="三段式提交">三段式提交&lt;/h2>
&lt;p>（3 Phase Commit，3PC）&lt;/p>
&lt;ul>
&lt;li>
&lt;p>在事务需要回滚的场景中：三段式的性能通常是要比两段式好很多的。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>但在事务能够正常提交的场景中：两者的性能都依然很差，甚至三段式因为多了一次询问，还要稍微更差一些。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="cancommit">&lt;strong>CanCommit&lt;/strong>&lt;/h3>
&lt;p>轻操作&lt;/p>
&lt;h3 id="precommit">&lt;strong>PreCommit&lt;/strong>&lt;/h3>
&lt;p>重操作&lt;/p>
&lt;h3 id="cancommit-1">&lt;strong>CanCommit&lt;/strong>&lt;/h3>
&lt;p>轻操作&lt;/p></description></item><item><title>本地事务</title><link>https://fengzhenbing.github.io/p/%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1/</link><pubDate>Wed, 12 Aug 2020 14:16:25 +0600</pubDate><guid>https://fengzhenbing.github.io/p/%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1/</guid><description>&lt;h2 id="1-介绍">1 介绍&lt;/h2>
&lt;p>本地事务（局部事务）在程序代码层面，最多只能对事务接口做一层标准化的包装（如 JDBC 接口），并不能深入参与到事务的运作过程当中，事务的开启、终止、提交、回滚、嵌套、设置隔离级别，乃至与应用代码贴近的事务传播方式，全部都要依赖底层数据源的支持才能工作。&lt;/p>
&lt;h2 id="2-原子性a和持久性d">2 原子性（A）和持久性（D）&lt;/h2>
&lt;p>崩溃 （Crash）：数据库、操作系统一侧的崩溃，甚至是机器突然断电宕机等意外情况。&lt;/p>
&lt;p>崩溃恢复（Crash Recovery，也有资料称作 Failure Recovery 或 Transaction Recovery）:为了保证原子性和持久性，就只能在崩溃后采取恢复的补救措施&lt;/p>
&lt;h3 id="commit-logging">Commit Logging&lt;/h3>
&lt;p>为了能够顺利地完成崩溃恢复，在磁盘中写入数据就不能像程序修改内存中变量值那样，直接改变某表某行某列的某个值，而是必须将修改数据这个操作所需的全部信息，包括修改什么数据、数据物理上位于哪个内存页和磁盘块中、从什么值改成什么值，等等，以日志的形式——即仅进行顺序追加的文件写入的形式（这是最高效的写入方式）先记录到磁盘中。只有在日志记录全部都安全落盘，数据库在日志中看到代表事务成功提交的“提交记录”（Commit Record）后，才会根据日志上的信息对真正的数据进行修改，修改完成后，再在日志中加入一条“结束记录”（End Record）表示事务已完成持久化.&lt;/p>
&lt;p>阿里的&lt;a class="link" href="https://zh.wikipedia.org/wiki/OceanBase" target="_blank" rel="noopener"
>OceanBase&lt;/a> 采用Commit Logging 机制来实现事务&lt;/p>
&lt;p>缺点：所有对数据的真实修改都必须发生在事务提交以后，即日志写入了 Commit Record 之后。在此之前，即使磁盘 I/O 有足够空闲、即使某个事务修改的数据量非常庞大，占用了大量的内存缓冲区，无论有何种理由，都决不允许在事务提交之前就修改磁盘上的数据。&lt;/p>
&lt;h3 id="write-ahead-logging">Write-Ahead Logging&lt;/h3>
&lt;p>按照事务提交时点为界，划分为 FORCE 和 STEAL 两类情况。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>FORCE&lt;/strong>：当事务提交后，要求变动数据必须同时完成写入则称为 FORCE，如果不强制变动数据必须同时完成写入则称为 NO-FORCE。现实中绝大多数数据库采用的都是 NO-FORCE 策略，因为只要有了日志，变动数据随时可以持久化，从优化磁盘 I/O 性能考虑，没有必要强制数据写入立即进行。&lt;/li>
&lt;li>&lt;strong>STEAL&lt;/strong>：在事务提交前，允许变动数据提前写入则称为 STEAL，不允许则称为 NO-STEAL。从优化磁盘 I/O 性能考虑，允许数据提前写入，有利于利用空闲 I/O 资源，也有利于节省数据库缓存区的内存。&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://fengzhenbing.github.io/data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAnYAAAD3CAMAAACn&amp;#43;emfAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyFpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8&amp;#43;IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDE0IDc5LjE1MTQ4MSwgMjAxMy8wMy8xMy0xMjowOToxNSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpDNkVCQjZENkRDQjExMUVBQjJFNUFDQzNEQ0I4MEI1RiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpDNkVCQjZEN0RDQjExMUVBQjJFNUFDQzNEQ0I4MEI1RiI&amp;#43;IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkM2RUJCNkQ0RENCMTExRUFCMkU1QUNDM0RDQjgwQjVGIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkM2RUJCNkQ1RENCMTExRUFCMkU1QUNDM0RDQjgwQjVGIi8&amp;#43;IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY&amp;#43;IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8&amp;#43;k8yiTAAAADNQTFRFkpKSS0tL3t7eXl5eenp67&amp;#43;/v9/f3sLCwzMzMp6en39/fxsbGhoaGMjIymcz/8zM/7dxksgAACUhJREFUeNrs3YmaojgUhmEEEXqmj8X9X&amp;#43;1kIZKwKFAJEeY79XSpWGXr329WmbHoKOrwKoiAgh0FO4qCHQU7ioIdBTuKgh0FO4qCHQU7CnYUdR125a2q1V97K7vucReR4QkU6lbbtWKqqgtz2f/c/dH1v7S9WvO3xH/cPHWN/DKwk8Y&amp;#43;07pST7q8mWeuqpH2cTcvoPC&amp;#43;978yOrLtLyzUYzfRHzcbuyvkl4OdepZF/0e3paZ/Jq8nP355jRTey97eWJskj5uP3QXyy8FOddnqmZrG2qk2W7gxwj370ct73Kt/zM/ujS38h4n1uPnYXSC/DOz&amp;#43;qqFAPVPdeZvY&amp;#43;lFC52mv9i/PzCHMOFLYQ/ti0zMg&amp;#43;4txHzcbuyvkl4FdoeYjf6exqWt6xjptVY2ZKDf7edi5dvzHzcTuCvnlYKdfhzdIuNjcdHn08lRfXtuZ824e/ZIr&amp;#43;uNmYneB/LKwG6bFZsaqm2njTV/Dl6cHD7ti38&amp;#43;jrqaxxXjcTOzOn18Wdqp/NhsArrnYV6ZuNTOduV286&amp;#43;/7YivUY9oBKe7jZmR3/vzysKur6XanbrMmtWDqKv/avSgd72syu31qUiR43IzsTp8fb45RGQp2FOwo2FEU7CjYURTsKNhRFOwo2FFUenZymcrzz3PV/GAHuyuyO&amp;#43;Kf5pm88rG7Zn6wgx3sYAc7YoMd7GAHO9jBDnawgx3syA92sIMd7MgPdrCDHexgR2ywgx3sYEdssIMd7GAHO/KDHexgBzvygx3sYAc72BEb7GAHO9gRG&amp;#43;xgBzvYwY78YAc72MGO/GAHO9jBDnbEBjvYwQ52xAY72MEOdrAjP9jBDnawO2t&amp;#43;&amp;#43;n933V9TX8/lnxXYwS5GfjKQm7B7/R/YYQe7&amp;#43;PkFrHx2/qX3OQCwg93v8hthEn3gOdyaYUlvB7sIg6z35ykSDLOwg13Kud1r5HSDrMzd92GMhR3s9vV2bpBd7O3YQIFdkt7OfTHIbmEXjgOyvql&amp;#43;LbvhI&amp;#43;REfXXLPytRVrLL7GS0zt3ErpCm68qbPtSqF3QrX8d1Ffo&amp;#43;ddm&amp;#43;jtwf/VV1pa6GQ9/KbpJXZHZH5jf61MKA3fRTDSVObyeDrHl2T9nFrqptbI0OpzAJ6eN9gK2OtdHfzBF983FXv1JXVV1X48S&amp;#43;vrd7Pwnexe7Y/AJWPjv/8vNnk27o7RaWFE6j7GSnmqSOzbZYE4kXW5&amp;#43;MvmWO6NuNa9JnYBc2zw/Dwi52h&amp;#43;U3wiT6QDfcmmEZYd8u2E8Zs3zfhj&amp;#43;wu5U6ssa2U5dJH5tprPqifcVWu2S/n10Yomu6sdkdlp94f8xPecNsJHZHnQpQ3P5IoWPrc&amp;#43;rTG93U6blBYgirn5s039vbydyIEZfdgfmFI6cbZGXuvk&amp;#43;f/52fXVnIn5nYxEyQ/dj6jPzYvn2QlfC9nY87nHvYHZdf0Nu5QXaxt&amp;#43;u&amp;#43;u7cr9VprGCTC1voaJExrVc2zHaYvZ2AX7LInWckemN&amp;#43;4t3Nfpxxky2FabKfEjajV2fyUuNXrthMtKURkxE7Wu1vL7tD8JNg/WWIno3Xu79glON9Oh6EaYeFW&amp;#43;dMNgMLfACjUzRNtoIh7Ozspu6Pym/R2MsiaZ9dt3kAZLcKewbo23vl2JoxGptud7tqw3WlXYnZ3yt/udGPGl65kg95uyzC7mt2R&amp;#43;YW93cKSwmmUHeyCKxJsnXC&amp;#43;3fpBwqcmwcXZ3hyb7NsF&amp;#43;yljlm8XsmvZPYN3InhPllMBUp0KMEyIJ5tQsINdQnZBH&amp;#43;cPspxvB7sD2HlbnZxvB7uDB1lhbge75OwmE7kE59vBDnbvNlBEninOt4Md7N5sF0vwX47FO98OdrB7P8iGJ95FOt8OdrDLcCoAscEOdrCDHbHBDnawgx3syA92sIMd7MgPdrCDHexgR2ywgx3sYEdssIMd7GAHO/KDHexgBzvygx3sYAc72BEb7GAHO9gRG&amp;#43;xgBzvYwQ52sIMd7GBHfrCDHexgBztigx3sYAc7YoMd7GAHO9jBDnawg93wkq5SudhdMz/Ywe6K7H6S1zEDUS5218wPdrCDHexgR2ywgx3sYAc72MEOdrCDHfnBDnawgx35wQ52sIMd7IgNdrCDHeyIDXawgx3sYEd&amp;#43;sIMd7GBHfrCDHexgBztigx3sYAc7YoMd7GAHO9iRH&amp;#43;xgBzvYkR/sYAc72MGO2GAHO9jBjthgBzvYwQ525Ac72MEOduQHO9jBDnawIzbYwQ52sCM22MEOdrCDHfmdj13/eWjuVn8Adp8yeH2S3Lqkfp&amp;#43;f7LhnA7vCvBh17&amp;#43;NuL/sj94e62qort7Krq&amp;#43;HQb9kFsYi9emZ2qfLzPrNwgml035TkRnbBxyPKcDu4LzI7FYuuulKplDf1zRxppem6RlqdYmvuS9Lbyel7u7T5ySJC&amp;#43;ZlwlAWun9kFV2S49O4LDb4RvI2dvdRpmWs6qfLWdEOkkdgF36/Q2yXNz0Mm7tukf5NJH7e1txtd6eHJhF303q5Ppq6KITbTWKOyC5uiDXLDjOWL2aXJTxZuiddm47CzHZjvT7ouPbvyVriAXoOEa8hubtL8vreTMJzh6&amp;#43;zskuQn4o&amp;#43;ytpHOLDDe3VrNLujj/EE2GFU/fsb4piXFrfRjcxl5scUaZE0cr6nwJXq7dPlJ2EoXO0J528dtZae&amp;#43;BUuKNX3c7wdZ01pV82z7GXFkdsMA8bN&amp;#43;UnemQTZefv7EdzQ7Ga1kUwyycsjcbjQlbqWquwRLCpuUx06uspKNnZ8M5OYw&amp;#43;ffIaLkmP/Pd5OolhTU3s5J9cZRY7OrKBOU2AAq9BRV/A0Vsnlfat0uZnyxtF4vM9HKf9gdWb6CIdAtLCglWuRHYeduddiWmIwu3O1WuMVayo0F2dWf33eyS5Le0dg1jG4&amp;#43;4MtrX27pdLN4YGy4ivOnf2d6TFa8pSt9sT7ykSJrfhN3wtoQnT2bfxfj5zSAr3eK&amp;#43;3duFLKcCXOs9WU4FgB35wQ52sIMd&amp;#43;cEOdrCDHeyIDXawgx3siA12sIMd7GBHfrCDHexgR36wgx3sYAc7YoMd7GAHO2KDHexgBzvYkR/sYAc72JEf7GAHO9jBjthgBzvYwY7YYAc72MEOduQHO9jBDnbkBzvYwQ52sCM22MEOdrAjNtjBDnawgx3sYAc72MGO/GAHO9jBDnZp/7qrVC5218wPdrC7HjuKmivYUbCjYEdRsKNgR1Gwo2BHUbCjYEdRsKNgR/1v6j8BBgBwlHBpFQqO/AAAAABJRU5ErkJggg==" alt="force-steal" />&lt;/p>
&lt;p>Write-Ahead Logging 在崩溃恢复时会执行以下三个阶段的操作：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>分析阶段&lt;/strong>（Analysis）：该阶段从最后一次检查点（Checkpoint，可理解为在这个点之前所有应该持久化的变动都已安全落盘）开始扫描日志，找出所有没有 End Record 的事务，组成待恢复的事务集合，这个集合至少会包括 Transaction Table 和 Dirty Page Table 两个组成部分。&lt;/li>
&lt;li>&lt;strong>重做阶段&lt;/strong>（Redo）：该阶段依据分析阶段中产生的待恢复的事务集合来重演历史（Repeat History），具体操作为：找出所有包含 Commit Record 的日志，将这些日志修改的数据写入磁盘，写入完成后在日志中增加一条 End Record，然后移除出待恢复事务集合。&lt;/li>
&lt;li>&lt;strong>回滚阶段&lt;/strong>（Undo）：该阶段处理经过分析、重做阶段后剩余的恢复事务集合，此时剩下的都是需要回滚的事务，它们被称为 Loser，根据 Undo Log 中的信息，将已经提前写入磁盘的信息重新改写回去，以达到回滚这些 Loser 事务的目的。&lt;/li>
&lt;/ul>
&lt;h3 id="shadow-paging">Shadow Paging&lt;/h3>
&lt;p>副本方式&lt;/p>
&lt;p>对数据的变动会写到硬盘的数据中，但并不是直接就地修改原先的数据，而是先将数据复制一份副本，保留原数据，修改副本数据。&lt;/p>
&lt;p>事务完成修改数据引用指针 （修改指针保证原子性）&lt;/p>
&lt;h2 id="3-隔离性">3 隔离性&lt;/h2>
&lt;h3 id="锁">锁&lt;/h3>
&lt;h4 id="写锁">&lt;strong>写锁&lt;/strong>&lt;/h4>
&lt;p>（Write Lock，也叫作排他锁，eXclusive Lock，简写为 X-Lock）：如果数据有加写锁，就只有持有写锁的事务才能对数据进行写入操作，数据加持着写锁时，其他事务不能写入数据，也不能施加读锁。&lt;/p>
&lt;h4 id="读锁">读锁&lt;/h4>
&lt;p>（Read Lock，也叫作共享锁，Shared Lock，简写为 S-Lock）：多个事务可以对同一个数据添加多个读锁，数据被加上读锁后就不能再被加上写锁，所以其他事务不能对该数据进行写入，但仍然可以读取。对于持有读锁的事务，如果该数据只有它自己一个事务加了读锁，允许直接将其升级为写锁，然后写入数据。&lt;/p>
&lt;h4 id="范围锁">范围锁&lt;/h4>
&lt;p>对于某个范围直接加排他锁，在这个范围内的数据不能被写入&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">books&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">price&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOR&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">UPDATE&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>以下四种隔离级别属于数据库理论的基础知识， 其实不同隔离级别以及幻读、不可重复读、脏读等问题都只是表面现象，是各种锁在不同加锁时间上组合应用所产生的结果，以锁为手段来实现隔离性才是数据库表现出不同隔离级别的根本原因。&lt;/p>
&lt;h3 id="完全不加锁">完全不加锁。。。&lt;/h3>
&lt;h3 id="读未提交">读未提交&lt;/h3>
&lt;p>缺点：出现赃读&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">books&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cm">/* 时间顺序：1，事务： T1 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="cm">/* 注意没有COMMIT */&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">UPDATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">books&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">price&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">90&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cm">/* 时间顺序：2，事务： T2 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="cm">/* 这条SELECT模拟购书的操作的逻辑 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">books&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cm">/* 时间顺序：3，事务： T1 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">ROLLBACK&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cm">/* 时间顺序：4，事务： T2 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>实现方式：不加读锁 ，还是有写锁的，不会出现赃写&lt;/p>
&lt;h3 id="读已提交">读已提交&lt;/h3>
&lt;p>缺点：不可重复读，只能读到提交的数据。 缺乏贯穿整个事务周期的读锁，无法禁止读取过的数据发生变化，&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">books&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cm">/* 时间顺序：1，事务： T1 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">UPDATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">books&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">price&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMIT&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cm">/* 时间顺序：2，事务： T2 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">books&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMIT&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cm">/* 时间顺序：3，事务： T1 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>实现方式：对事务涉及的数据加的写锁会一直持续到事务结束，但加的读锁在查询操作完成后就马上会释放。&lt;/p>
&lt;h3 id="可重复读">可重复读&lt;/h3>
&lt;p>相对于读已提交，读锁存在时间为整个事物周期&lt;/p>
&lt;p>缺点：可能出现幻读&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">books&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">price&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cm">/* 时间顺序：1，事务： T1 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">books&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">price&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;深入理解Java虚拟机&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">90&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cm">/* 时间顺序：2，事务： T2 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">books&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">price&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cm">/* 时间顺序：3，事务： T1 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>实现方式：对事务所涉及的数据加读锁和写锁，且一直持有至事务结束，但不再加范围锁。&lt;/p>
&lt;h3 id="可串行化">可串行化&lt;/h3>
&lt;p>缺点：顺序执行，吞吐量低，性能低&lt;/p>
&lt;p>实现方式： 对事务所有读、写的数据全都加上读锁、写锁和范围锁；实际还是很复杂的，要分成 Expanding 和 Shrinking 两阶段去处理读锁、写锁与数据间的关系，称为&lt;a class="link" href="https://en.wikipedia.org/wiki/Two-phase_locking" target="_blank" rel="noopener"
>Two-Phase Lock&lt;/a>，2PL&lt;/p>
&lt;h2 id="4-多版本并发控制">4 多版本并发控制&lt;/h2>
&lt;p>参考 （https://icyfenix.cn/architect-perspective/general-architecture/transaction/local.html）&lt;/p></description></item></channel></rss>